<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RUBRIC - Expenses</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { padding-top: 60px; font-size: 0.9rem; }
    .navbar { position: fixed; top: 0; width: 100%; z-index: 1000; }
    .container { margin-top: 80px; }
    table { font-size: 0.8rem; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="index.html">
      <img src="town_seal.png" alt="Town Seal" style="height:40px; margin-right:10px;">
      Rutland Budget Portal
    </a>
  </nav>

  <div class="container">
    <h1 class="mb-4">Expenses by Department</h1>
    <canvas id="expensesChart" height="100"></canvas>
    <table class="table table-bordered mt-4">
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    const chartOfAccountsURL = "budget portal chart of accounts.csv";
    const budgetDataURL = "budget.csv";
    const fiscalYears = ["FY21 ACTUALS", "FY22 ACTUALS", "FY23 ACTUALS", "FY24 ACTUALS", "FY25 BUDGET", "FY26 BUDGET"];

    let chartOfAccountsMap = {};

    function parseCurrency(value) {
      if (!value) return 0;
      return parseFloat(value.toString().replace(/[$,]/g, "")) || 0;
    }

    function formatDollar(val) {
      return "$" + Math.round(val).toLocaleString("en-US");
    }

    function loadAndRender() {
      Papa.parse(chartOfAccountsURL, {
        download: true,
        header: true,
        complete: function(results) {
          results.data.forEach(row => {
            chartOfAccountsMap[row["Account Number"]] = {
              function: row["Function"],
              department: row["Department Name"]
            };
          });
          loadBudgetData();
        }
      });
    }

    function loadBudgetData() {
      Papa.parse(budgetDataURL, {
        download: true,
        header: true,
        complete: function(results) {
          const data = results.data;
          const merged = [];

          data.forEach(row => {
            const acct = row["Account Number"];
            if (chartOfAccountsMap[acct]) {
              merged.push({
                ...row,
                Function: chartOfAccountsMap[acct].function,
                Department: chartOfAccountsMap[acct].department
              });
            }
          });

          renderChartAndTable(merged);
        }
      });
    }

    function renderChartAndTable(data) {
      const departmentTotals = {};
      const tableHead = document.getElementById("tableHead");
      const tableBody = document.getElementById("tableBody");

      tableHead.innerHTML = "<tr><th>Department</th>" + fiscalYears.map(y => `<th>${y}</th>`).join("") + "</tr>";
      tableBody.innerHTML = "";

      data.forEach(row => {
        const dept = row["Department"];
        if (!dept) return;
        if (!departmentTotals[dept]) {
          departmentTotals[dept] = {};
          fiscalYears.forEach(y => departmentTotals[dept][y] = 0);
        }
        fiscalYears.forEach(y => departmentTotals[dept][y] += parseCurrency(row[y]));
      });

      const labels = [];
      const values = [];

      Object.keys(departmentTotals).sort().forEach(dept => {
        labels.push(dept);
        values.push(departmentTotals[dept]["FY26 BUDGET"] || 0);

        const rowHTML = `<tr><td>${dept}</td>` +
                        fiscalYears.map(y => `<td>${formatDollar(departmentTotals[dept][y])}</td>`).join("") +
                        "</tr>";
        tableBody.innerHTML += rowHTML;
      });

      new Chart(document.getElementById("expensesChart").getContext("2d"), {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: "FY26 Budget",
            data: values,
            backgroundColor: "rgba(54, 162, 235, 0.6)"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return formatDollar(context.raw);
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return "$" + value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    window.onload = loadAndRender;
  </script>
</body>
</html>
