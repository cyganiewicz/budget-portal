<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutland Budget Portal - Expenses</title>
  <!-- Bootstrap CSS for styling -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- Chart.js for dynamic charting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { padding-top: 60px; font-size: 0.9rem; }
    .navbar { position: fixed; top: 0; width: 100%; z-index: 1000; }
    .sidebar {
      height: 100vh; overflow-y: auto; position: fixed; left: 0; top: 60px;
      width: 250px; background-color: #f8f9fa; padding: 15px; border-right: 1px solid #ddd;
    }
    .sidebar h5 { margin-bottom: 0.25rem; }
    .sidebar small { display: block; margin-bottom: 1rem; color: #666; }
    .content { margin-left: 270px; padding: 20px; }
    /* Center chart and summary containers */
    #chartContainer, #summaryTable { margin: 0 auto; max-width: 800px; text-align: center; margin-bottom: 30px; }
    canvas { display: block; margin: 0 auto; background: #fff; }
    /* Summary table styling */
    #summaryTable table { width: 100%; border-collapse: separate; border-spacing: 0; }
    #summaryTable thead { background-color: #f2f2f2; color: #333; }
    #summaryTable thead th { padding: 8px; border: 1px solid #ddd; white-space: nowrap; }
    #summaryTable tbody td { padding: 8px; border: 1px solid #ddd; white-space: nowrap; }
    #summaryTable tbody tr:nth-child(odd) { background-color: #f9f9f9; }
    #summaryTable tbody tr:nth-child(even) { background-color: #fff; }
    /* Detailed budget table styling */
    #budgetTable { font-size: 0.8rem; width: 100%; }
    .table-responsive {
      max-height: 600px;
      overflow-y: auto;
      position: relative;
    }
    #budgetTable thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #f2f2f2;
    }
    #budgetTable thead th, #budgetTable tbody td {
      padding: 8px;
      border: 1px solid #ddd;
      white-space: nowrap;
    }
    #budgetTable tbody tr:nth-child(odd) { background-color: #f9f9f9; }
    #budgetTable tbody tr:nth-child(even) { background-color: #fff; }
    /* Chart toggle styling */
    #chartToggle { margin-bottom: 15px; }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="index.html">
      <img src="town_seal.png" alt="Town Seal" style="height:40px; margin-right:10px;">
      Rutland Budget Portal
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarNav" aria-controls="navbarNav"
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mr-auto">
         <li class="nav-item"><a class="nav-link" href="index.html">Overview</a></li>
         <li class="nav-item"><a class="nav-link" href="revenues.html">Revenues</a></li>
         <li class="nav-item active"><a class="nav-link" href="expenses.html">Expenses <span class="sr-only">(current)</span></a></li>
         <li class="nav-item"><a class="nav-link" href="reserves.html">Reserves</a></li>
         <li class="nav-item"><a class="nav-link" href="capital.html">Capital</a></li>
         <li class="nav-item"><a class="nav-link" href="forecast.html">Forecast</a></li>
         <li class="nav-item"><a class="nav-link" href="benchmarks.html">Benchmarking</a></li>
      </ul>
      <span class="navbar-text">
         <a class="nav-link" href="https://www.rutlandma.gov/finance" target="_blank" style="color:#fff;">Back to RutlandMA.gov</a>
      </span>
    </div>
  </nav>

  <!-- Sidebar -->
  <div class="sidebar">
    <h5>Functions & Departments</h5>
    <small>Click to skip to detail</small>
    <div id="sidebarContainer"></div>
  </div>

  <!-- Main Content -->
  <div class="content">
    <!-- Chart Toggle -->
    <div id="chartToggle" class="text-center">
      <button class="btn btn-sm btn-outline-primary" data-type="line">Line</button>
      <button class="btn btn-sm btn-outline-primary" data-type="bar">Bar</button>
      <button class="btn btn-sm btn-outline-primary" data-type="line" data-fill="true">Mountain</button>
    </div>

    <!-- Line/Bar Chart -->
    <div id="chartContainer">
      <canvas id="lineChart" width="800" height="400"></canvas>
    </div>

    <!-- Summary Table -->
    <h3>Expense Summary by Function (FY21–FY26)</h3>
    <div id="summaryTable">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Function</th>
            <th>FY21</th>
            <th>FY22</th>
            <th>FY23</th>
            <th>FY24</th>
            <th>FY25</th>
            <th>FY26</th>
            <th>Δ $</th>
            <th>Δ %</th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </div>

    <!-- Detailed Budget Table -->
    <h3>Budget Detail</h3>
    <div class="table-responsive">
      <table class="table table-striped" id="budgetTable">
        <thead>
          <tr>
            <th>Account</th>
            <th>Description</th>
            <th>FY21</th>
            <th>FY22</th>
            <th>FY23</th>
            <th>FY24</th>
            <th>FY25</th>
            <th>FY26</th>
            <th>Δ $</th>
            <th>Δ %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
  // formatting helpers
  function formatShortDollar(v) {
    if (v >= 1e6) return '$'+(v/1e6).toFixed(1)+'M';
    if (v >= 1e3) return '$'+(v/1e3).toFixed(1)+'k';
    return '$'+v;
  }
  function formatDollar(v) {
    return '$'+Math.round(v).toLocaleString();
  }
  function getNum(item, key) {
    return Math.round(parseFloat((item[key]||'0').replace(/,/g,''))||0);
  }

  // chart-of-accounts map
  let chartMap = {};

  function loadChartOfAccounts(cb) {
    Papa.parse('chartofAccounts.csv', {
      download: true, header: true,
      complete: (res) => {
        res.data.forEach(r=>{
          const code = String(r['Department Code']).trim();
          chartMap[code] = {
            department: r['Department Name'].trim(),
            func:       r['Function'].trim()
          };
        });
        cb();
      }
    });
  }

  function classifyAccount(acct) {
    if (!acct) return { func:'Other', department:'Other' };
    const parts = acct.split('-');
    if (parts.length<2) return { func:'Other', department:'Other' };
    return chartMap[parts[1]] || { func:'Other', department:'Other' };
  }

  // fiscal columns
  const fiscalCols = [
    { key:'FY21 ACTUALS', label:'FY21' },
    { key:'FY22 ACTUALS', label:'FY22' },
    { key:'FY23 ACTUALS', label:'FY23' },
    { key:'FY24 BUDGET',  label:'FY24' },
    { key:'FY25 BUDGET',  label:'FY25' },
    { key:'FY26 BUDGET',  label:'FY26' }
  ];

  let rawData=[],
      currentChart;

  // load budget data
  function loadBudget() {
    Papa.parse('budget.csv',{
      download:true, header:true,
      complete: ({data})=> {
        rawData = data;
        drawAll();
      }
    });
  }

  // draw summary, detail, sidebar, chart
  function drawAll(type='line', fill=false) {
    const byFunc = {};
    rawData.forEach(r=>{
      const acct = (r['Account Number']||'').trim();
      const info = classifyAccount(acct);
      const func = info.func, dept = info.department;
      if (func==='Other') return;
      byFunc[func] = byFunc[func]||{ __depts:{} };
      byFunc[func].__depts[dept] = byFunc[func].__depts[dept]||[];
      byFunc[func].__depts[dept].push(r);
      // accumulate per year
      fiscalCols.forEach(c=>{
        byFunc[func][c.label] = (byFunc[func][c.label]||0)+getNum(r,c.key);
      });
    });

    // build summary table
    const sumBody = document.getElementById('summaryBody');
    sumBody.innerHTML = '';
    let grand={}, prevTotals={};
    fiscalCols.forEach(c=>grand[c.label]=0);
    Object.keys(byFunc).sort().forEach(func=>{
      const d = byFunc[func];
      let row='<tr><td>'+func+'</td>';
      fiscalCols.forEach(c=>{
        row+='<td>'+formatDollar(d[c.label])+'</td>';
        grand[c.label]+=d[c.label];
      });
      const d25=grand['FY25'], d26=grand['FY26'];
      const diff= d26-d25,
            pct = d25?((diff/d25)*100).toFixed(1)+'%':'N/A';
      row+='<td>'+formatDollar(diff)+'</td><td>'+pct+'</td></tr>';
      sumBody.insertAdjacentHTML('beforeend',row);
    });
    // grand total row
    let prow='<tr><td><strong>Grand Total</strong></td>';
    fiscalCols.forEach(c=>prow+='<td><strong>'+formatDollar(grand[c.label])+'</strong></td>');
    const d25=grand['FY25'], d26=grand['FY26'], diff=d26-d25,
          pct=d25?((diff/d25)*100).toFixed(1)+'%':'N/A';
    prow+='<td><strong>'+formatDollar(diff)+'</strong></td><td><strong>'+pct+'</strong></td></tr>';
    sumBody.insertAdjacentHTML('beforeend',prow);

    // build detail table
    const dt = document.querySelector('#budgetTable tbody');
    dt.innerHTML = '';
    Object.keys(byFunc).sort().forEach(func=>{
      // function header
      dt.insertAdjacentHTML('beforeend',
        `<tr><td colspan="10" style="background:#d1ecf1"><strong>${func}</strong></td></tr>`
      );
      Object.keys(byFunc[func].__depts).sort().forEach(dept=>{
        dt.insertAdjacentHTML('beforeend',
          `<tr><td colspan="10" id="${dept.replace(/\s+/g,'-')}" style="background:#e2e3e5">
             ${dept}
           </td></tr>`
        );
        byFunc[func].__depts[dept].forEach(r=>{
          const vals = fiscalCols.map(c=>getNum(r,c.key));
          const diff=vals[5]-vals[4], pct= vals[4]?((diff/vals[4])*100).toFixed(1)+'%':'N/A';
          dt.insertAdjacentHTML('beforeend',
            `<tr>
               <td>${r['Account Number']}</td>
               <td>${r['Description']}</td>
               ${vals.map(v=>'<td>'+formatDollar(v)+'</td>').join('')}
               <td>${formatDollar(diff)}</td><td>${pct}</td>
             </tr>`
          );
        });
      });
    });

    // sidebar
    const sb=document.getElementById('sidebarContainer');
    sb.innerHTML='';
    Object.keys(byFunc).sort().forEach(func=>{
      const div=document.createElement('div');
      div.innerHTML=`<strong>${func}</strong>`;
      sb.appendChild(div);
      const ul=document.createElement('ul');
      ul.classList.add('list-unstyled','pl-2');
      Object.keys(byFunc[func].__depts).sort().forEach(d=>{
        const a=document.createElement('a');
        a.href='#'+d.replace(/\s+/g,'-');
        a.innerText=d;
        const li=document.createElement('li');
        li.appendChild(a);
        ul.appendChild(li);
      });
      sb.appendChild(ul);
    });

    // chart
    const labels = fiscalCols.map(c=>c.label);
    const datasets = Object.keys(byFunc).sort().map((func,i)=>{
      const color = `hsl(${i*40 % 360},60%,50%)`;
      return {
        label: func,
        data: fiscalCols.map(c=>byFunc[func][c.label]),
        borderColor: color,
        backgroundColor: color,
        fill: fill,
        type: type==='bar'? 'bar': 'line',
        tension:0.1
      };
    });
    const ctx = document.getElementById('lineChart').getContext('2d');
    if (currentChart) currentChart.destroy();
    currentChart = new Chart(ctx,{
      data:{ labels, datasets },
      options:{
        plugins:{ legend:{ position:'bottom' } },
        scales:{
          y:{ ticks:{ callback:v=>formatShortDollar(v) } },
          x:{ title:{ display:true,text:'Fiscal Year' } }
        }
      }
    });
  }

  // wire up toggle buttons
  document.getElementById('chartToggle').addEventListener('click',e=>{
    if(e.target.dataset.type){
      drawAll(e.target.dataset.type, e.target.dataset.fill==='true');
    }
  });

  // on load: first COA, then budget
  window.onload = ()=> loadChartOfAccounts(loadBudget);
  </script>

  <!-- Bootstrap JS (for navbar toggle) -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
</body>
</html>
