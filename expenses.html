<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutland Budget Portal - Expenses</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { padding-top: 60px; font-size: 0.9rem; }
    .navbar { position: fixed; top: 0; width: 100%; z-index: 1000; }
    .sidebar {
      position: fixed; top: 60px; left: 0; width: 250px; height: calc(100vh - 60px);
      overflow-y: auto; background: #f8f9fa; padding: 1rem; border-right: 1px solid #ddd;
    }
    .sidebar h5 { margin-bottom: 0.5rem; }
    .sidebar ul { padding-left: 1rem; }
    .sidebar a { display: block; margin-bottom: 0.25rem; color: #007bff; text-decoration: none; }
    .sidebar a:hover { text-decoration: underline; }
    .content { margin-left: 270px; padding: 1rem; }
    /* Chart container */
    #chartControls { text-align: center; margin-bottom: 1rem; }
    #chartContainer { max-width: 800px; margin: 0 auto 2rem; }
    canvas { background: #fff; }
    /* Summary table */
    #summaryTable table { width: 100%; border-collapse: separate; border-spacing: 0; }
    #summaryTable th, #summaryTable td {
      padding: 0.5rem; border: 1px solid #ddd; white-space: nowrap;
    }
    #summaryTable thead { background: #f2f2f2; }
    #summaryTable tbody tr:nth-child(odd)  { background: #f9f9f9; }
    #summaryTable tbody tr:nth-child(even) { background: #fff; }
    /* Detailed table */
    .table-responsive { max-height: 600px; overflow-y: auto; position: relative; }
    #budgetTable { width: 100%; font-size: 0.8rem; border-collapse: separate; border-spacing: 0; }
    #budgetTable th, #budgetTable td {
      padding: 0.5rem; border: 1px solid #ddd; white-space: nowrap;
    }
    #budgetTable thead { position: sticky; top: 0; background: #f2f2f2; z-index: 10; }
    #budgetTable tbody tr:nth-child(odd)  { background: #f9f9f9; }
    #budgetTable tbody tr:nth-child(even) { background: #fff; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="index.html">
      <img src="town_seal.png" style="height:40px; margin-right:10px;">Rutland Budget Portal
    </a>
    <button class="navbar-toggler" data-toggle="collapse" data-target="#navMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Overview</a></li>
        <li class="nav-item"><a class="nav-link" href="revenues.html">Revenues</a></li>
        <li class="nav-item active"><a class="nav-link" href="expenses.html">Expenses</a></li>
        <li class="nav-item"><a class="nav-link" href="reserves.html">Reserves</a></li>
        <li class="nav-item"><a class="nav-link" href="capital.html">Capital</a></li>
        <li class="nav-item"><a class="nav-link" href="forecast.html">Forecast</a></li>
        <li class="nav-item"><a class="nav-link" href="benchmarks.html">Benchmarking</a></li>
      </ul>
      <span class="navbar-text">
        <a class="nav-link" href="https://www.rutlandma.gov/finance" target="_blank">Back to RutlandMA.gov</a>
      </span>
    </div>
  </nav>

  <!-- Sidebar -->
  <div class="sidebar">
    <h5>Functions & Departments</h5>
    <div id="sidebarContainer"></div>
  </div>

  <!-- Main Content -->
  <div class="content">
    <h3>Expense Spending Overview (FY21–FY26)</h3>

    <!-- Chart Type Toggle -->
    <div id="chartControls">
      <div class="btn-group" role="group">
        <button class="btn btn-sm btn-outline-primary" data-type="line">Line</button>
        <button class="btn btn-sm btn-outline-primary" data-type="bar">Stacked Bar</button>
        <button class="btn btn-sm btn-outline-primary" data-type="pie">Pie (FY26)</button>
      </div>
    </div>

    <!-- Chart -->
    <div id="chartContainer">
      <canvas id="expenseChart" width="800" height="400"></canvas>
    </div>

    <!-- Summary Table -->
    <div id="summaryTable">
      <h4>Summary by Function</h4>
      <table>
        <thead>
          <tr>
            <th>Function</th>
            <th>FY21</th>
            <th>FY22</th>
            <th>FY23</th>
            <th>FY24</th>
            <th>FY25</th>
            <th>FY26</th>
            <th>Δ $</th>
            <th>Δ %</th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </div>

    <!-- Detail Table -->
    <h4 class="mt-4">Budget Detail</h4>
    <div class="table-responsive">
      <table id="budgetTable">
        <thead>
          <tr>
            <th>Account #</th>
            <th>Description</th>
            <th>FY21</th>
            <th>FY22</th>
            <th>FY23</th>
            <th>FY24</th>
            <th>FY25</th>
            <th>FY26</th>
            <th>Δ $</th>
            <th>Δ %</th>
          </tr>
        </thead>
        <tbody id="detailBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const fiscalCols = {
      FY21: 'FY21 ACTUALS',
      FY22: 'FY22 ACTUALS',
      FY23: 'FY23 ACTUALS',
      FY24: 'FY24 ACTUALS',
      FY25: 'FY25 BUDGET',
      FY26: 'FY26 BUDGET'
    };
    let chartMap = {}, budgetData = [], currentChart, chartType = 'line';

    // load chart of accounts
    function loadCOA(cb) {
      Papa.parse('chartofAccounts.csv', {
        download: true, header: true,
        complete: res => {
          res.data.forEach(r=>{
            const acct = r['Account Number']?.trim();
            if(acct) chartMap[acct] = {
              dept: r['Department Name'],
              func: r['Function']
            };
          });
          cb();
        }
      });
    }
    // classify
    function classify(acct) {
      return chartMap[acct] || {dept:'Other', func:'Other'};
    }
    // number helpers
    function round(n){ return Math.round(parseFloat(n)||0); }
    function fmt(n){ return '$'+round(n).toLocaleString(); }
    // load budget data
    function loadBudget(){
      Papa.parse('budget.csv',{download:true,header:true,
        complete: res => {
          budgetData = res.data;
          drawAll();
        }
      });
    }
    // aggregate by function
    function aggByFunc(){
      const funcs = {}, years = Object.keys(fiscalCols);
      // init
      years.forEach(y=> funcs[y]=[]);
      budgetData.forEach(row=>{
        const acct=row['Account Number']?.trim();
        const {func} = classify(acct);
        if(!funcs[func]) funcs[func]={};
        years.forEach(y=>{
          const v = round(row[fiscalCols[y]]);
          funcs[func][y]=(funcs[func][y]||0)+v;
        });
      });
      return {years, data:funcs};
    }
    // draw chart
    function drawChart(){
      const {years,data} = aggByFunc();
      const labels = Object.keys(data).filter(f=>f!=='').sort();
      let ds=[], total26=[];
      labels.forEach((f,i)=>{
        const vals = years.map(y=>data[f][y]||0);
        ds.push({
          label:f,
          data: chartType==='pie' ? [ data[f]['FY26']||0 ] : vals,
          backgroundColor: ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b'][i%6],
          borderColor:'#fff'
        });
        total26.push(data[f]['FY26']||0);
      });
      if(currentChart) currentChart.destroy();
      const ctx=document.getElementById('expenseChart');
      currentChart=new Chart(ctx,{
        type: chartType,
        data: {
          labels: chartType==='pie' ? labels : years,
          datasets: ds
        },
        options: chartType==='pie'
          ? { plugins:{legend:{position:'bottom'}} }
          : {
            plugins:{legend:{position:'bottom'}},
            scales:{
              x: { stacked: chartType==='bar' },
              y: { stacked: chartType==='bar', ticks:{callback:v=> v>=1e6?`$${v/1e6}M`:`$${v/1e3}k`} }
            }
          }
      });
    }
    // populate summary
    function fillSummary(){
      const {years,data} = aggByFunc();
      const tb=document.getElementById('summaryBody');
      tb.innerHTML='';
      let grand = years.reduce((g,y)=>({...g,[y]:0}),{});
      Object.keys(data).sort().forEach(f=>{
        let row='<tr><td>'+f+'</td>';
        years.forEach(y=>{
          const v=data[f][y]||0;
          row+='<td>'+fmt(v)+'</td>';
          grand[y]+=v;
        });
        const d=grand['FY26']-grand['FY25'],
              p=grand['FY25']?d/grand['FY25']*100:0;
        row+=`<td>${fmt(data[f]['FY26']-data[f]['FY25'])}</td>
              <td>${data[f]['FY25']?((data[f]['FY26']-data[f]['FY25'])/data[f]['FY25']*100).toFixed(1)+'%':'N/A'}</td></tr>`;
        tb.insertAdjacentHTML('beforeend',row);
      });
      // grand total
      let gr='<tr><td><strong>Grand Total</strong></td>';
      years.forEach(y)=> gr+=`<td><strong>${fmt(grand[y])}</strong></td>`;
      const gd=grand['FY26']-grand['FY25'],
            gp=grand['FY25']?gd/grand['FY25']*100:0;
      gr+=`<td><strong>${fmt(gd)}</strong></td><td><strong>${grand['FY25']?gp.toFixed(1)+'%':'N/A'}</strong></td></tr>`;
      tb.insertAdjacentHTML('beforeend',gr);
    }
    // populate detail & sidebar
    function fillDetailAndSidebar(){
      const years=Object.keys(fiscalCols),
            tbody=document.getElementById('detailBody'),
            sb=document.getElementById('sidebarContainer');
      tbody.innerHTML=''; sb.innerHTML='';
      // group
      const byF={}, byS={}; // byF: func→dept→rows
      budgetData.forEach(r=>{
        const acct=r['Account Number']?.trim(),
              {func,dept}=classify(acct);
        byF[func]=byF[func]||{};
        byF[func][dept]=byF[func][dept]||[];
        byF[func][dept].push(r);
      });
      // sidebar
      Object.keys(byF).sort().forEach(f=>{
        sb.insertAdjacentHTML('beforeend',`<strong>${f}</strong>`);
        const ul=document.createElement('ul');
        Object.keys(byF[f]).sort().forEach(d=>{
          const li=document.createElement('li'),
                a=document.createElement('a');
          a.href='#'+d.replace(/\s+/g,'-');
          a.innerText=d;
          li.appendChild(a);
          ul.appendChild(li);
        });
        sb.appendChild(ul);
      });
      // detail table
      const grand = years.reduce((g,y)=>({...g,[y]:0}),{});
      Object.keys(byF).sort().forEach(func=>{
        // func header
        tbody.insertAdjacentHTML('beforeend',
          `<tr><td colspan="10" style="background:#e9ecef;"><strong>${func}</strong></td></tr>`);
        const funcTot = years.reduce((f,y)=>({...f,[y]:0}),{});
        Object.keys(byF[func]).sort().forEach(dept=>{
          // dept header
          tbody.insertAdjacentHTML('beforeend',
            `<tr id="${dept.replace(/\s+/g,'-')}">
              <td colspan="10" style="background:#f8f9fa;">${dept}</td>
            </tr>`);
          const deptTot = years.reduce((d,y)=>({...d,[y]:0}),{});
          // rows
          byF[func][dept].forEach(r=>{
            const vals=years.map(y=>round(r[fiscalCols[y]])),
                  diff=vals[5]-vals[4],
                  pct=vals[4]?diff/vals[4]*100:0;
            let row=`<tr>
              <td>${r['Account Number']}</td>
              <td>${r['Description']||''}</td>`;
            vals.forEach(v=>row+=`<td>${fmt(v)}</td>`);
            row+=`<td>${fmt(diff)}</td><td>${vals[4]?pct.toFixed(1)+'%':'N/A'}</td></tr>`;
            tbody.insertAdjacentHTML('beforeend',row);
            years.forEach((y,i)=>{ deptTot[y]+=vals[i]; funcTot[y]+=vals[i]; grand[y]+=vals[i]; });
          });
          // dept subtotal
          const dd=deptTot, dDiff=dd['FY26']-dd['FY25'], dPct=dd['FY25']?dDiff/dd['FY25']*100:0;
          let dr=`<tr style="font-weight:bold;">
            <td colspan="2">Total ${dept}</td>`;
          years.forEach(y=>dr+=`<td>${fmt(dd[y])}</td>`);
          dr+=`<td>${fmt(dDiff)}</td><td>${dd['FY25']?dPct.toFixed(1)+'%':'N/A'}</td></tr>`;
          tbody.insertAdjacentHTML('beforeend',dr);
        });
        // func subtotal
        const fd=funcTot, fDiff=fd['FY26']-fd['FY25'], fPct=fd['FY25']?fDiff/fd['FY25']*100:0;
        let fr=`<tr style="font-weight:bold; background:#dee2e6;">
          <td colspan="2">Total ${func}</td>`;
        years.forEach(y=>fr+=`<td>${fmt(fd[y])}</td>`);
        fr+=`<td>${fmt(fDiff)}</td><td>${fd['FY25']?fPct.toFixed(1)+'%':'N/A'}</td></tr>`;
        tbody.insertAdjacentHTML('beforeend',fr);
      });
      // grand total
      const gd=grand, gDiff=gd['FY26']-gd['FY25'], gPct=gd['FY25']?gDiff/gd['FY25']*100:0;
      let gr=`<tr style="font-weight:bold; background:#adb5bd; color:#fff;">
        <td colspan="2">Grand Total</td>`;
      years.forEach(y=>gr+=`<td>${fmt(gd[y])}</td>`);
      gr+=`<td>${fmt(gDiff)}</td><td>${gd['FY25']?gPct.toFixed(1)+'%':'N/A'}</td></tr>`;
      tbody.insertAdjacentHTML('beforeend',gr);
    }

    // run everything
    function drawAll(){
      drawChart();
      fillSummary();
      fillDetailAndSidebar();
    }
    // chart toggle
    document.getElementById('chartControls').addEventListener('click',e=>{
      if(e.target.dataset?.type){
        chartType=e.target.dataset.type;
        drawChart();
      }
    });

    // init
    window.onload = ()=> loadCOA(loadBudget);
  </script>
  <!-- Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
</body>
</html>
