<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutland Budget Portal - Expenses</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { padding-top: 60px; font-size: 0.9rem; }
    .navbar { position: fixed; top: 0; width: 100%; z-index: 1000; }
    .sidebar {
      position: fixed; top: 60px; left: 0; width: 250px; height: calc(100vh - 60px);
      overflow-y: auto; background: #f8f9fa; padding: 1rem; border-right: 1px solid #ddd;
    }
    .sidebar h5 { margin-bottom: 0.5rem; }
    .sidebar ul { padding-left: 1rem; }
    .sidebar a { display: block; margin-bottom: 0.25rem; color: #007bff; text-decoration: none; }
    .sidebar a:hover { text-decoration: underline; }
    .content { margin-left: 270px; padding: 1rem; }
    #chartControls { text-align: center; margin-bottom: 1rem; }
    #chartContainer { max-width: 800px; margin: 0 auto 2rem; }
    canvas { background: #fff; }
    #summaryTable table { width: 100%; border-collapse: separate; border-spacing: 0; }
    #summaryTable th, #summaryTable td {
      padding: 0.5rem; border: 1px solid #ddd; white-space: nowrap;
    }
    #summaryTable thead { background: #f2f2f2; }
    #summaryTable tbody tr:nth-child(odd)  { background: #f9f9f9; }
    #summaryTable tbody tr:nth-child(even) { background: #fff; }
    .table-responsive { max-height: 600px; overflow-y: auto; position: relative; }
    #budgetTable { width: 100%; font-size: 0.8rem; border-collapse: separate; border-spacing: 0; }
    #budgetTable th, #budgetTable td {
      padding: 0.5rem; border: 1px solid #ddd; white-space: nowrap;
    }
    #budgetTable thead { position: sticky; top: 0; background: #f2f2f2; z-index: 10; }
    #budgetTable tbody tr:nth-child(odd)  { background: #f9f9f9; }
    #budgetTable tbody tr:nth-child(even) { background: #fff; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="index.html">
      <img src="town_seal.png" style="height:40px; margin-right:10px;">Rutland Budget Portal
    </a>
    <button class="navbar-toggler" data-toggle="collapse" data-target="#navMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMenu">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Overview</a></li>
        <li class="nav-item"><a class="nav-link" href="revenues.html">Revenues</a></li>
        <li class="nav-item active"><a class="nav-link" href="expenses.html">Expenses</a></li>
        <li class="nav-item"><a class="nav-link" href="reserves.html">Reserves</a></li>
        <li class="nav-item"><a class="nav-link" href="capital.html">Capital</a></li>
        <li class="nav-item"><a class="nav-link" href="forecast.html">Forecast</a></li>
        <li class="nav-item"><a class="nav-link" href="benchmarks.html">Benchmarking</a></li>
      </ul>
      <span class="navbar-text">
        <a class="nav-link" href="https://www.rutlandma.gov/finance" target="_blank">Back to RutlandMA.gov</a>
      </span>
    </div>
  </nav>

  <div class="sidebar">
    <h5>Functions & Departments</h5>
    <div id="sidebarContainer"></div>
  </div>

  <div class="content">
    <h3>Expense Spending Overview (FY21–FY26)</h3>
    <div id="chartControls">
      <div class="btn-group" role="group">
        <button class="btn btn-sm btn-outline-primary" data-type="line">Line</button>
        <button class="btn btn-sm btn-outline-primary" data-type="bar">Stacked Bar</button>
        <button class="btn btn-sm btn-outline-primary" data-type="pie">Pie (FY26)</button>
      </div>
    </div>
    <div id="chartContainer">
      <canvas id="expenseChart" width="800" height="400"></canvas>
    </div>

    <div id="summaryTable">
      <h4>Summary by Function</h4>
      <table>
        <thead>
          <tr>
            <th>Function</th><th>FY21</th><th>FY22</th><th>FY23</th>
            <th>FY24</th><th>FY25</th><th>FY26</th><th>Δ $</th><th>Δ %</th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </div>

    <h4 class="mt-4">Budget Detail</h4>
    <div class="table-responsive">
      <table id="budgetTable">
        <thead>
          <tr>
            <th>Account #</th><th>Description</th>
            <th>FY21</th><th>FY22</th><th>FY23</th>
            <th>FY24</th><th>FY25</th><th>FY26</th>
            <th>Δ $</th><th>Δ %</th>
          </tr>
        </thead>
        <tbody id="detailBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    var fiscalCols = {
      FY21: 'FY21 ACTUALS',
      FY22: 'FY22 ACTUALS',
      FY23: 'FY23 ACTUALS',
      FY24: 'FY24 ACTUALS',
      FY25: 'FY25 BUDGET',
      FY26: 'FY26 BUDGET'
    };
    var chartMap = {}, budgetData = [], currentChart, chartType = 'line';

    function loadCOA(cb) {
      Papa.parse('chartofAccounts.csv', { download:true, header:true,
        complete: function(res) {
          res.data.forEach(function(r){
            var acct = (r['Account Number']||'').trim();
            if(acct) {
              chartMap[acct] = {
                dept: r['Department']||'Other',
                func: r['Category']||r['Function']||'Other'
              };
            }
          });
          cb();
        }
      });
    }
    function classify(acct) {
      return chartMap[acct] || { dept:'Other', func:'Other' };
    }
    function round(n){ return Math.round(parseFloat(n)||0); }
    function fmt(n){ return '$'+round(n).toLocaleString(); }

    function loadBudget(){
      Papa.parse('budget.csv', {
        download:true, header:true,
        complete: function(res){
          budgetData = res.data;
          drawAll();
        }
      });
    }

    function aggByFunc(){
      var years = Object.keys(fiscalCols),
          funcs = {};
      budgetData.forEach(function(r){
        var acct = (r['Account Number']||'').trim(),
            f = classify(acct).func;
        funcs[f] = funcs[f]||{};
        years.forEach(function(y){
          funcs[f][y] = (funcs[f][y]||0) + round(r[fiscalCols[y]]);
        });
      });
      return { years: years, data: funcs };
    }

    function drawChart(){
      var obj = aggByFunc(),
          years = obj.years,
          data = obj.data,
          labels = Object.keys(data).sort(),
          datasets = [];

      labels.forEach(function(f,i){
        var vals = years.map(function(y){ return data[f][y]||0; });
        datasets.push({
          label: f,
          data: chartType==='pie' ? [ data[f]['FY26']||0 ] : vals,
          backgroundColor: ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b'][i%6],
          borderColor: '#fff'
        });
      });

      if(currentChart) currentChart.destroy();
      var ctx = document.getElementById('expenseChart').getContext('2d');
      currentChart = new Chart(ctx, {
        type: chartType,
        data: {
          labels: chartType==='pie' ? labels : years,
          datasets: datasets
        },
        options: chartType==='pie' ? {
          plugins: { legend: { position:'bottom' } }
        } : {
          plugins: { legend: { position:'bottom' } },
          scales: {
            x: { stacked: chartType==='bar' },
            y: {
              stacked: chartType==='bar',
              ticks: {
                callback: function(v){ return v>=1e6 ? '$'+(v/1e6).toFixed(1)+'M' : '$'+(v/1e3).toFixed(1)+'k'; }
              }
            }
          }
        }
      });
    }

    function fillSummary(){
      var agg = aggByFunc(),
          years = agg.years,
          data = agg.data,
          tb = document.getElementById('summaryBody');
      tb.innerHTML = '';
      var grand = {};
      years.forEach(function(y){ grand[y]=0; });

      Object.keys(data).sort().forEach(function(f){
        var row = '<tr><td>'+f+'</td>';
        years.forEach(function(y){
          var v = data[f][y]||0;
          row += '<td>'+fmt(v)+'</td>';
          grand[y] += v;
        });
        var diff = (data[f]['FY26']||0)-(data[f]['FY25']||0),
            pct  = data[f]['FY25'] ? diff/data[f]['FY25']*100 : 0;
        row += '<td>'+fmt(diff)+'</td>'
             + '<td>'+(data[f]['FY25'] ? pct.toFixed(1)+'%' : 'N/A')+'</td></tr>';
        tb.insertAdjacentHTML('beforeend', row);
      });

      var gr = '<tr><td><strong>Grand Total</strong></td>';
      years.forEach(function(y){
        gr += '<td><strong>'+fmt(grand[y])+'</strong></td>';
      });
      var gdiff = grand['FY26']-grand['FY25'],
          gpct  = grand['FY25'] ? gdiff/grand['FY25']*100 : 0;
      gr += '<td><strong>'+fmt(gdiff)+'</strong></td>'
         + '<td><strong>'+(grand['FY25']?gpct.toFixed(1)+'%':'N/A')+'</strong></td></tr>';
      tb.insertAdjacentHTML('beforeend', gr);
    }

    function fillDetailAndSidebar(){
      var years = Object.keys(fiscalCols),
          tb = document.getElementById('detailBody'),
          sb = document.getElementById('sidebarContainer');
      tb.innerHTML = '';
      sb.innerHTML = '';

      var byF = {};
      budgetData.forEach(function(r){
        var acct = (r['Account Number']||'').trim(),
            info = classify(acct);
        byF[info.func] = byF[info.func]||{};
        byF[info.func][info.dept] = byF[info.func][info.dept]||[];
        byF[info.func][info.dept].push(r);
      });

      // sidebar
      Object.keys(byF).sort().forEach(function(func){
        sb.insertAdjacentHTML('beforeend','<strong>'+func+'</strong>');
        var ul = document.createElement('ul');
        Object.keys(byF[func]).sort().forEach(function(dept){
          var li = document.createElement('li'),
              a  = document.createElement('a');
          a.href = '#'+dept.replace(/\s+/g,'-');
          a.innerText = dept;
          li.appendChild(a);
          ul.appendChild<li>;
        });
        sb.appendChild(ul);
      });

      // detail table
      var grand = {};
      years.forEach(function(y){ grand[y]=0; });

      Object.keys(byF).sort().forEach(function(func){
        tb.insertAdjacentHTML('beforeend',
          '<tr><td colspan="10" style="background:#e9ecef;"><strong>'+func+'</strong></td></tr>');
        var funcTot = {};
        years.forEach(function(y){ funcTot[y]=0; });

        Object.keys(byF[func]).sort().forEach(function(dept){
          tb.insertAdjacentHTML('beforeend',
            '<tr id="'+dept.replace(/\s+/g,'-')+'">'
            +'<td colspan="10" style="background:#f8f9fa;">'+dept+'</td></tr>');

          var deptTot = {};
          years.forEach(function(y){ deptTot[y]=0; });

          byF[func][dept].forEach(function(r){
            var vals = years.map(function(y){ return round(r[fiscalCols[y]]); }),
                diff = vals[5]-vals[4],
                pct  = vals[4] ? diff/vals[4]*100 : 0;
            var row = '<tr><td>'+r['Account Number']+'</td>'
                    + '<td>'+ (r['Description']||'') +'</td>';
            vals.forEach(function(v){ row += '<td>'+fmt(v)+'</td>'; });
            row += '<td>'+fmt(diff)+'</td>'
                 + '<td>'+(vals[4]?pct.toFixed(1)+'%':'N/A')+'</td></tr>';
            tb.insertAdjacentHTML('beforeend', row);

            years.forEach(function(y,i){
              deptTot[y] += vals[i];
              funcTot[y] += vals[i];
              grand[y]   += vals[i];
            });
          });

          var ddiff = deptTot['FY26']-deptTot['FY25'],
              dpct  = deptTot['FY25']?ddiff/deptTot['FY25']*100:0,
              drow  = '<tr style="font-weight:bold;">'
                    + '<td colspan="2">Total '+dept+'</td>';
          years.forEach(function(y){
            drow += '<td>'+fmt(deptTot[y])+'</td>';
          });
          drow += '<td>'+fmt(ddiff)+'</td>'
               + '<td>'+(deptTot['FY25']?dpct.toFixed(1)+'%':'N/A')+'</td></tr>';
          tb.insertAdjacentHTML('beforeend', drow);
        });

        var fdiff = funcTot['FY26']-funcTot['FY25'],
            fpct  = funcTot['FY25']?fdiff/funcTot['FY25']*100:0,
            frow  = '<tr style="font-weight:bold; background:#dee2e6;">'
                  + '<td colspan="2">Total '+func+'</td>';
        years.forEach(function(y){
          frow += '<td>'+fmt(funcTot[y])+'</td>';
        });
        frow += '<td>'+fmt(fdiff)+'</td>'
             + '<td>'+(funcTot['FY25']?fpct.toFixed(1)+'%':'N/A')+'</td></tr>';
        tb.insertAdjacentHTML('beforeend', frow);
      });

      // grand total
      var gdiff = grand['FY26']-grand['FY25'],
          gpct  = grand['FY25']?gdiff/grand['FY25']*100:0,
          grow  = '<tr style="font-weight:bold; background:#adb5bd; color:#fff;">'
                + '<td colspan="2">Grand Total</td>';
      years.forEach(function(y){
        grow += '<td>'+fmt(grand[y])+'</td>';
      });
      grow += '<td>'+fmt(gdiff)+'</td>'
           + '<td>'+(grand['FY25']?gpct.toFixed(1)+'%':'N/A')+'</td></tr>';
      tb.insertAdjacentHTML('beforeend', grow);
    }

    function drawAll(){
      drawChart();
      fillSummary();
      fillDetailAndSidebar();
    }

    document.getElementById('chartControls').addEventListener('click', function(e){
      if(e.target.dataset && e.target.dataset.type){
        chartType = e.target.dataset.type;
        drawChart();
      }
    });

    window.onload = function(){
      loadCOA(loadBudget);
    };
  </script>

  <!-- Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
</body>
</html>
