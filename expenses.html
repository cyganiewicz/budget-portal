<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RUBRIC - Expenses</title>
  <!-- Bootstrap CSS for styling -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- Chart.js for dynamic charting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { padding-top: 60px; font-size: 0.9rem; }
    .navbar { position: fixed; top: 0; width: 100%; z-index: 1000; }
    .sidebar {
      height: 100vh; overflow-y: auto; position: fixed; left: 0; top: 60px;
      width: 250px; background-color: #f8f9fa; padding: 15px; border-right: 1px solid #ddd;
    }
    .sidebar h5 { margin-bottom: 0.25rem; }
    .sidebar small { display: block; margin-bottom: 1rem; color: #666; }
    .content { margin-left: 270px; padding: 20px; }
    /* Center chart and summary containers */
    #chartContainer, #summaryTable { margin: 0 auto; max-width: 800px; text-align: center; margin-bottom: 30px; }
    canvas { display: block; margin: 0 auto; background: #fff; }
    /* Summary table styling */
    #summaryTable table { width: 100%; border-collapse: separate; border-spacing: 0; }
    #summaryTable thead { background-color: #f2f2f2; color: #333; }
    #summaryTable thead th { padding: 8px; border: 1px solid #ddd; white-space: nowrap; }
    #summaryTable tbody td { padding: 8px; border: 1px solid #ddd; white-space: nowrap; }
    #summaryTable tbody tr:nth-child(odd) { background-color: #f9f9f9; }
    #summaryTable tbody tr:nth-child(even) { background-color: #fff; }
    /* Detailed budget table styling */
    #budgetTable { font-size: 0.8rem; width: 100%; }
    .table-responsive { max-height: 600px; overflow-y: auto; position: relative; }
    #budgetTable thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #f2f2f2;
    }
    #budgetTable thead th, #budgetTable tbody td {
      padding: 8px;
      border: 1px solid #ddd;
      white-space: nowrap;
    }
    #budgetTable tbody tr:nth-child(odd) { background-color: #f9f9f9; }
    #budgetTable tbody tr:nth-child(even) { background-color: #fff; }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="index.html">
      <img src="town_seal.png" alt="Town Seal" style="height:40px; margin-right:10px;">
      Rutland's Unified Budget Review and Information Center
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" 
            data-target="#navbarNav" aria-controls="navbarNav" 
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mr-auto">
         <li class="nav-item"><a class="nav-link" href="index.html">Overview</a></li>
         <li class="nav-item"><a class="nav-link" href="revenues.html">Revenues</a></li>
         <li class="nav-item active"><a class="nav-link" href="expenses.html">Expenses <span class="sr-only">(current)</span></a></li>
         <li class="nav-item"><a class="nav-link" href="reserves.html">Reserves</a></li>
         <li class="nav-item"><a class="nav-link" href="capital.html">Capital</a></li>
         <li class="nav-item"><a class="nav-link" href="forecast.html">Forecast</a></li>
         <li class="nav-item"><a class="nav-link" href="benchmarks.html">Benchmarking</a></li>
      </ul>
      <span class="navbar-text">
         <a class="nav-link" href="https://www.rutlandma.gov/finance" target="_blank" style="color:#fff;">Back to RutlandMA.gov</a>
      </span>
    </div>
  </nav>

  <!-- Sidebar -->
  <div class="sidebar">
    <h5>Departmental Budgets</h5>
    <small>click to skip to departmental budget detail</small>
    <div id="sidebarContainer"></div>
  </div>

  <!-- Main Content -->
  <div class="content">
    <!-- Line Chart -->
    <h3>Expense Spending Overview (FY21 - FY26)</h3>
    <div id="chartContainer">
      <canvas id="lineChart" width="800" height="400"></canvas>
    </div>

    <!-- Summary Table -->
    <h3>Expense Summary by Category (FY21 â€“ FY26)</h3>
    <div id="summaryTable">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Category</th>
            <th>FY21 Actuals</th>
            <th>FY22 Actuals</th>
            <th>FY23 Actuals</th>
            <th>FY24 Actuals</th>
            <th>FY25 Budget</th>
            <th>FY26 Budget</th>
            <th>Diff ($)</th>
            <th>Diff (%)</th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </div>

    <!-- Detailed Budget Table -->
    <h3>Budget Detail</h3>
    <div class="table-responsive">
      <table class="table table-striped" id="budgetTable">
        <thead>
          <tr>
            <th>Account Number</th>
            <th>Description</th>
            <th>FY21 ACTUALS</th>
            <th>FY22 ACTUALS</th>
            <th>FY23 ACTUALS</th>
            <th>FY24 ACTUALS</th>
            <th>FY25 BUDGET</th>
            <th>FY26 BUDGET</th>
            <th>Diff ($)</th>
            <th>Diff (%)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Helper Functions -->
  <script>
    function formatShortDollar(value) {
      const num = +value;
      if (num >= 1e6) return "$" + (num / 1e6).toFixed(1) + "M";
      if (num >= 1e3) return "$" + (num / 1e3).toFixed(1) + "k";
      return "$" + num;
    }
    function formatDollar(value) {
      return "$" + Math.round(value).toLocaleString("en-US");
    }
    function getNum(item, key) {
      return Math.round(parseFloat((item[key] || "0").replace(/,/g, "")) || 0);
    }
  </script>

  <!-- Main Script -->
  <script>
    const DEBUG = true;
    let expenseData = [];

    const fiscalColumns = {
      "FY21 Actuals": "FY21 ACTUALS",
      "FY22 Actuals": "FY22 ACTUALS",
      "FY23 Actuals": "FY23 ACTUALS",
      "FY24 Actuals": "FY24 ACTUALS",
      "FY25 Budget": "FY25 BUDGET",
      "FY26 Budget": "FY26 BUDGET"
    };

    // department + category mapping (same as before)
    const deptMapping = {/* ... existing deptMapping ... */};
    function classifyAccount(accountNumber) {/* ... existing classifyAccount ... */}

    function aggregateExpenseData(data) {
      const years = Object.values(fiscalColumns);
      const agg = {};
      Object.keys(fiscalColumns).forEach(label => { agg[label] = { fiscalYear: label }; });
      data.forEach(item => {
        const acct = (item["Account Number"] || "").trim();
        const info = classifyAccount(acct);
        if (info.category === "Other") return;
        Object.keys(fiscalColumns).forEach(label => {
          const col = fiscalColumns[label];
          const val = parseFloat(item[col] || "0");
          agg[label][info.category] = (agg[label][info.category] || 0) + (isNaN(val) ? 0 : val);
        });
      });
      return Object.keys(fiscalColumns).map(label => ({ fiscalYear: label, ...agg[label] }));
    }

    function buildChartDatasets(aggregatedData) {
      const categories = new Set();
      aggregatedData.forEach(d => Object.keys(d).filter(k => k!="fiscalYear").forEach(c=>categories.add(c)));
      const cats = Array.from(categories).sort();
      const labels = aggregatedData.map(d=>d.fiscalYear);
      const colors = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd"];
      return {
        labels,
        datasets: cats.map((cat,i)=>({
          label: cat,
          data: aggregatedData.map(d=>d[cat]||0),
          borderColor: colors[i%colors.length],
          backgroundColor: colors[i%colors.length],
          fill:false,tension:0.1
        }))
      };
    }

    function drawLineChart(data) {
      const ctx = document.getElementById('lineChart').getContext('2d');
      new Chart(ctx,{
        type:'line',
        data:buildChartDatasets(data),
        options:{
          responsive:true,
          plugins:{legend:{position:'bottom'}},
          scales:{x:{title:{display:true,text:'Fiscal Year'}},y:{title:{display:true,text:'Amount'},ticks:{callback:formatShortDollar}}}
        }
      });
    }

    function aggregateSummaryTable(data) {
      const summary = {};
      data.forEach(item=>{
        const acct=(item['Account Number']||'').trim();
        const info=classifyAccount(acct);
        if(info.category==='Other')return;
        summary[info.category]=summary[info.category]||{category:info.category};
        Object.keys(fiscalColumns).forEach(label=>{
          summary[info.category][label]=(summary[info.category][label]||0)+getNum(item,fiscalColumns[label]);
        });
      });
      return summary;
    }

    function populateSummaryTable(data) {
      const tbody=document.getElementById('summaryBody'); tbody.innerHTML='';
      const summary=aggregateSummaryTable(data);
      const grand={}; Object.keys(fiscalColumns).forEach(label=>grand[label]=0);
      Object.keys(summary).sort().forEach(cat=>{
        const d=summary[cat]; let row=`<tr><td>${cat}</td>`;
        Object.keys(fiscalColumns).forEach(label=>{row+=`<td>${formatDollar(d[label])}</td>`;grand[label]+=d[label];});
        const diff=grand['FY26 Budget']-grand['FY25 Budget'];
        row+=`<td>${formatDollar(d['FY26 Budget']-d['FY25 Budget'])}</td>`;
        const pct=d['FY25 Budget']?(((d['FY26 Budget']-d['FY25 Budget'])/d['FY25 Budget'])*100).toFixed(1)+'%':'N/A';
        row+=`<td>${pct}</td></tr>`;
        tbody.insertAdjacentHTML('beforeend',row);
      });
      // grand total
      let gtRow='<tr><td><strong>Grand Total</strong></td>';
      Object.keys(fiscalColumns).forEach(label=>gtRow+=`<td><strong>${formatDollar(grand[label])}</strong></td>`);
      const gd=grand['FY26 Budget']-grand['FY25 Budget'];
      gtRow+=`<td><strong>${formatDollar(gd)}</strong></td>`;
      const gpt=grand['FY25 Budget']?((gd/grand['FY25 Budget'])*100).toFixed(1)+'%':'N/A';
      gtRow+=`<td><strong>${gpt}</strong></td></tr>`;
      tbody.insertAdjacentHTML('beforeend',gtRow);
    }

    /** Updated combined detail & sidebar renderer **/
    function fillDetailAndSidebar(data) {
      // Sidebar
      const sidebar=document.getElementById('sidebarContainer');sidebar.innerHTML='';
      const catMap={};
      data.forEach(item=>{
        const acct=(item['Account Number']||'').trim();
        const info=classifyAccount(acct);
        if(info.category==='Other')return;
        catMap[info.category]=catMap[info.category]||new Set();
        catMap[info.category].add(info.department);
      });
      Object.keys(catMap).sort().forEach(cat=>{
        const h5=document.createElement('h5');h5.innerText=cat;sidebar.appendChild(h5);
        const ul=document.createElement('ul');ul.className='list-unstyled';
        Array.from(catMap[cat]).sort().forEach(dept=>{
          const li=document.createElement('li');
          const a=document.createElement('a'); a.href='#'+dept.replace(/\s+/g,'-');a.innerText=dept;
          li.appendChild(a);ul.appendChild(li);
        });
        sidebar.appendChild(ul);
      });

      // Detail table
      const tbody=document.querySelector('#budgetTable tbody');tbody.innerHTML='';
      const groups={};
      data.forEach(item=>{
        const acct=(item['Account Number']||'').trim();
        const info=classifyAccount(acct);
        if(info.category==='Other')return;
        groups[info.category]=groups[info.category]||{};
        groups[info.category][info.department]=groups[info.category][info.department]||[];
        groups[info.category][info.department].push(item);
      });

      // totals for grand
      const grandTotals={}; Object.keys(fiscalColumns).forEach(l=>grandTotals[l]=0);

      Object.keys(groups).sort().forEach(cat=>{
        // category header
        let tr=document.createElement('tr');
        tr.innerHTML=`<td colspan="10" style="background:#d1ecf1"><strong>${cat}</strong></td>`;
        tbody.appendChild(tr);
        const catTotals={}; Object.keys(fiscalColumns).forEach(l=>catTotals[l]=0);
        Object.keys(groups[cat]).sort().forEach(dept=>{
          // department header
          tr=document.createElement('tr');
          tr.id=dept.replace(/\s+/g,'-');
          tr.innerHTML=`<td colspan="10" style="background:#e2e3e5"><strong>${dept}</strong></td>`;
          tbody.appendChild(tr);
          const deptTotals={}; Object.keys(fiscalColumns).forEach(l=>deptTotals[l]=0);
          // rows
          groups[cat][dept].forEach(item=>{
            const vals=Object.keys(fiscalColumns).map(l=>getNum(item,fiscalColumns[l]));
            const diff=vals[5]-vals[4];
            const pct=vals[4]?((diff/vals[4])*100).toFixed(1)+'%':'N/A';
            tr=document.createElement('tr');
            tr.innerHTML=`<td>${item['Account Number']}</td><td>${item.Description}</td>`+
              vals.map(v=>`<td>${formatDollar(v)}</td>`).join('')+
              `<td>${formatDollar(diff)}</td><td>${pct}</td>`;
            tbody.appendChild(tr);
            Object.keys(fiscalColumns).forEach((l,i)=>deptTotals[l]+=vals[i]);
          });
          // dept subtotal
          const dDiff=deptTotals['FY26 Budget']-deptTotals['FY25 Budget'];
          const dPct=deptTotals['FY25 Budget']?((dDiff/deptTotals['FY25 Budget'])*100).toFixed(1)+'%':'N/A';
          tr=document.createElement('tr');
          tr.innerHTML=`<td colspan="2"><strong>Total for ${dept}</strong></td>`+
            Object.keys(fiscalColumns).map(l=>`<td><strong>${formatDollar(deptTotals[l])}</strong></td>`).join('')+
            `<td><strong>${formatDollar(dDiff)}</strong></td><td><strong>${dPct}</strong></td>`;
          tbody.appendChild(tr);
          Object.keys(deptTotals).forEach(l=>catTotals[l]+=deptTotals[l]);
        });
        // category subtotal
        const cDiff=catTotals['FY26 Budget']-catTotals['FY25 Budget'];
        const cPct=catTotals['FY25 Budget']?((cDiff/catTotals['FY25 Budget'])*100).toFixed(1)+'%':'N/A';
        tr=document.createElement('tr');
        tr.innerHTML=`<td colspan="2"><strong>Total for ${cat}</strong></td>`+
          Object.keys(fiscalColumns).map(l=>`<td><strong>${formatDollar(catTotals[l])}</strong></td>`).join('')+
          `<td><strong>${formatDollar(cDiff)}</strong></td><td><strong>${cPct}</strong></td>`;
        tbody.appendChild(tr);
        Object.keys(catTotals).forEach(l=>grandTotals[l]+=catTotals[l]);
      });

      // grand total
      const gDiff=grandTotals['FY26 Budget']-grandTotals['FY25 Budget'];
      const gPct=grandTotals['FY25 Budget']?((gDiff/grandTotals['FY25 Budget'])*100).toFixed(1)+'%':'N/A';
      const gTr=document.createElement('tr');
      gTr.innerHTML=`<td colspan="2"><strong>Grand Total</strong></td>`+
        Object.keys(fiscalColumns).map(l=>`<td><strong>${formatDollar(grandTotals[l])}</strong></td>`).join('')+
        `<td><strong>${formatDollar(gDiff)}</strong></td><td><strong>${gPct}</strong></td>`;
      tbody.appendChild(gTr);
    }

    function loadExpenseData() {
      Papa.parse("budget.csv",{
        download:true, header:true,
        complete: res=>{
          expenseData=res.data;
          const agg=aggregateExpenseData(expenseData);
          drawLineChart(agg);
          populateSummaryTable(expenseData);
          fillDetailAndSidebar(expenseData);
        }
      });
    }

    window.onload=loadExpenseData;
  </script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
</body>
</html>
