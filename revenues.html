<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutland Budget Portal - Revenues</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- Chart.js for charting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { padding-top: 60px; font-size: 0.9rem; }
    .navbar { position: fixed; top: 0; width: 100%; z-index: 1000; }
    .sidebar {
      height: 100vh; overflow-y: auto; position: fixed; left: 0; top: 60px;
      width: 250px; background-color: #f8f9fa; padding: 15px; border-right: 1px solid #ddd;
    }
    .sidebar h5 { margin-bottom: 0.25rem; }
    .sidebar small { display: block; margin-bottom: 1rem; color: #666; }
    .content { margin-left: 270px; padding: 20px; }
    /* Center chart and summary containers */
    #chartContainer, #summaryTable { margin: 0 auto; max-width: 800px; text-align: center; margin-bottom: 30px; }
    canvas { display: block; margin: 0 auto; background: #fff; }
    /* Summary table styling */
    #summaryTable table { width: 100%; border-collapse: separate; border-spacing: 0; }
    #summaryTable thead { background-color: #f2f2f2; color: #333; }
    #summaryTable thead th { padding: 8px; border: 1px solid #ddd; white-space: nowrap; }
    #summaryTable tbody td { padding: 8px; border: 1px solid #ddd; white-space: nowrap; }
    #summaryTable tbody tr:nth-child(odd) { background-color: #f9f9f9; }
    #summaryTable tbody tr:nth-child(even) { background-color: #fff; }
    /* Detailed table styling */
    #detailedTable { font-size: 0.8rem; width: 100%; }
    .table-responsive { max-height: 600px; overflow-y: auto; position: relative; }
    #detailedTable thead {
      position: sticky; top: 0; z-index: 10; background-color: #f2f2f2;
    }
    #detailedTable thead th, #detailedTable tbody td {
      padding: 8px; border: 1px solid #ddd; white-space: nowrap;
    }
    #detailedTable tbody tr:nth-child(odd) { background-color: #f9f9f9; }
    #detailedTable tbody tr:nth-child(even) { background-color: #fff; }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="#">
      <img src="town_seal.png" alt="Town Seal" style="height:40px; margin-right:10px;">
      Rutland Budget Portal
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" 
            data-target="#navbarNav" aria-controls="navbarNav" 
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mr-auto">
         <li class="nav-item"><a class="nav-link" href="index.html">Overview</a></li>
         <li class="nav-item active"><a class="nav-link" href="revenues.html">Revenues <span class="sr-only">(current)</span></a></li>
         <li class="nav-item"><a class="nav-link" href="expenses.html">Expenses</a></li>
      </ul>
      <span class="navbar-text">
         <a class="nav-link" href="https://www.rutlandma.gov/finance" target="_blank" style="color:#fff;">Back to RutlandMA.gov</a>
      </span>
    </div>
  </nav>

  <!-- Sidebar -->
  <div class="sidebar">
    <h5>Revenue Sources</h5>
    <small>click to jump to revenue detail</small>
    <div id="sidebarContainer">
      <!-- Sidebar content injected dynamically -->
    </div>
  </div>

  <!-- Main Content -->
  <div class="content">
    <!-- Bar Chart -->
    <h3>Revenue Overview (Bar Chart)</h3>
    <div id="chartContainer">
      <canvas id="barChart" width="800" height="400"></canvas>
    </div>

    <!-- Summary Table -->
    <h3>Revenue Summary by Category (FY21 – FY26)</h3>
    <div id="summaryTable">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Category</th>
            <th>FY21</th>
            <th>FY22</th>
            <th>FY23</th>
            <th>FY24</th>
            <th>FY25</th>
            <th>FY26</th>
            <th>Diff ($)</th>
            <th>Diff (%)</th>
          </tr>
        </thead>
        <tbody id="summaryBody">
          <!-- Summary rows injected dynamically -->
        </tbody>
      </table>
    </div>

    <!-- Detailed Revenue Table -->
    <h3>Revenue Detail</h3>
    <div class="table-responsive">
      <table class="table table-striped" id="detailedTable">
        <thead>
          <tr>
            <th>Subcategory1</th>
            <th>Subcategory2</th>
            <th>FY21</th>
            <th>FY22</th>
            <th>FY23</th>
            <th>FY24</th>
            <th>FY25</th>
            <th>FY26</th>
            <th>Diff ($)</th>
            <th>Diff (%)</th>
          </tr>
        </thead>
        <tbody>
          <!-- Detailed rows injected dynamically -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Helper Functions -->
  <script>
    // Remove commas and dollar signs before parsing a numeric value.
    function getNum(item, key) {
      if (!item) return 0;
      let s = item[key];
      if (s === undefined || s === null) return 0;
      s = s.toString().replace(/\$/g, "").replace(/,/g, "").trim();
      let n = parseFloat(s);
      console.log("getNum:", key, "raw =", item[key], "cleaned =", s, "number =", n);
      return Math.round(n || 0);
    }
    function formatShortDollar(value) {
      const num = +value;
      if (num >= 1e6) return "$" + (num / 1e6).toFixed(1) + "M";
      if (num >= 1e3) return "$" + (num / 1e3).toFixed(1) + "k";
      return "$" + num;
    }
    function formatDollar(value) {
      return "$" + Math.round(value).toLocaleString("en-US");
    }
  </script>

  <!-- Main Revenues Script -->
  <script>
    const DEBUG = true;
    let revenueData = [];
    // Allowed categories (for filtering, in lowercase)
    const allowedCategories = ["taxes", "local receipts", "state aid", "transfers in"];
    // Fiscal columns mapping – update these if your CSV headers differ.
    const fiscalColumns = {
      "FY21": "FY21 ACTUALS",
      "FY22": "FY22 ACTUALS",
      "FY23": "FY23 ACTUALS",
      "FY24": "FY24 ACTUALS",
      "FY25": "FY25 BUDGET",
      "FY26": "FY26 BUDGET"
    };

    // Log CSV headers and first row.
    function logCSVHeaders(data) {
      if (data.length > 0) {
        console.log("CSV Headers:", Object.keys(data[0]));
        console.log("First row:", data[0]);
        Object.keys(fiscalColumns).forEach(year => {
          console.log(year, "->", fiscalColumns[year], "=", data[0][fiscalColumns[year]]);
        });
      }
    }

    // classifyRevenue now returns the account number (for internal linking).
    function classifyRevenue(row) {
      let rawCat = row["Category"] ? row["Category"].trim() : "Other";
      const category = rawCat;
      const sub1 = row["Subcategory1"] ? row["Subcategory1"].trim() : "Other";
      let sub2 = row["Subcategory2"] ? row["Subcategory2"].trim() : "";
      if (!sub2) { sub2 = sub1; }
      const account = row["Account Number"] ? row["Account Number"].trim() : "";
      return { category, sub1, sub2, account };
    }

    // Filter rows by allowed categories (case‑insensitive).
    function filterRevenueData(data) {
      const filtered = data.filter(row => {
        const info = classifyRevenue(row);
        return allowedCategories.includes(info.category.toLowerCase());
      });
      if (DEBUG) {
        console.log("Filtered rows count:", filtered.length);
        const uniqueCats = [...new Set(filtered.map(r => classifyRevenue(r).category))];
        console.log("Unique Categories:", uniqueCats);
      }
      return filtered;
    }

    // Aggregate revenue data by category (for the chart and summary table).
    function aggregateRevenueData(data) {
      const years = Object.keys(fiscalColumns);
      const agg = {};
      years.forEach(year => { agg[year] = { fiscalYear: year }; });
      data.forEach(row => {
        const info = classifyRevenue(row);
        if (!allowedCategories.includes(info.category.toLowerCase())) return;
        years.forEach(year => {
          const col = fiscalColumns[year];
          const val = getNum(row, col);
          if (!agg[year][info.category]) agg[year][info.category] = 0;
          agg[year][info.category] += val;
        });
      });
      if (DEBUG) console.log("Aggregated Revenue Data:", agg);
      return years.map(year => agg[year]);
    }

    function buildChartDatasets(aggregatedData) {
      const labels = aggregatedData.map(d => d.fiscalYear);
      // Derive category keys from the first aggregated object (except fiscalYear)
      let cats = [];
      if (aggregatedData.length > 0) {
        cats = Object.keys(aggregatedData[0]).filter(k => k !== "fiscalYear");
      }
      const defaultColors = ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728"];
      const datasets = cats.map((cat, i) => {
        return {
          label: cat,
          data: aggregatedData.map(d => d[cat] || 0),
          backgroundColor: defaultColors[i % defaultColors.length],
          borderColor: defaultColors[i % defaultColors.length],
          borderWidth: 1
        };
      });
      return { labels, datasets };
    }

    function drawBarChart(aggregatedData) {
      const ctx = document.getElementById("barChart").getContext("2d");
      const chartData = buildChartDatasets(aggregatedData);
      new Chart(ctx, {
        type: 'bar',
        data: chartData,
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ": " + formatDollar(context.raw);
                }
              }
            },
            legend: { position: 'bottom' }
          },
          scales: {
            x: { title: { display: true, text: "Fiscal Year" } },
            y: {
              ticks: { callback: function(value) { return formatShortDollar(value); } },
              title: { display: true, text: "Revenue Amount" }
            }
          }
        }
      });
    }

    // Aggregate summary table data by category.
    function aggregateSummaryTable(data) {
      const summary = {};
      data.forEach(row => {
        const info = classifyRevenue(row);
        if (!allowedCategories.includes(info.category.toLowerCase())) return;
        if (!summary[info.category]) {
          summary[info.category] = { category: info.category };
          Object.keys(fiscalColumns).forEach(year => { summary[info.category][year] = 0; });
        }
        Object.keys(fiscalColumns).forEach(year => {
          const col = fiscalColumns[year];
          summary[info.category][year] += getNum(row, col);
        });
      });
      if (DEBUG) console.log("Summary Table Data:", summary);
      return summary;
    }

    function populateSummaryTable(data) {
      const filteredData = filterRevenueData(data);
      const summaryDataObj = aggregateSummaryTable(filteredData);
      const tbody = document.getElementById("summaryBody");
      tbody.innerHTML = "";
      const grandTotals = {};
      Object.keys(fiscalColumns).forEach(year => { grandTotals[year] = 0; });
      for (let cat in summaryDataObj) {
        const d = summaryDataObj[cat];
        let rowHTML = `<tr><td>${d.category}</td>`;
        Object.keys(fiscalColumns).forEach(year => {
          rowHTML += `<td>${formatDollar(d[year])}</td>`;
          grandTotals[year] += d[year];
        });
        const diffDollar = d["FY26"] - d["FY25"];
        const diffPercent = d["FY25"] !== 0 ? (diffDollar / d["FY25"] * 100) : 0;
        rowHTML += `<td>${formatDollar(diffDollar)}</td><td>${d["FY25"] !== 0 ? diffPercent.toFixed(1) + "%" : "N/A"}</td></tr>`;
        tbody.insertAdjacentHTML("beforeend", rowHTML);
      }
      let totalRowHTML = `<tr><td><strong>Grand Total</strong></td>`;
      Object.keys(fiscalColumns).forEach(year => {
        totalRowHTML += `<td><strong>${formatDollar(grandTotals[year])}</strong></td>`;
      });
      const totalDiffDollar = grandTotals["FY26"] - grandTotals["FY25"];
      const totalDiffPercent = grandTotals["FY25"] !== 0 ? (totalDiffDollar / grandTotals["FY25"] * 100) : 0;
      totalRowHTML += `<td><strong>${formatDollar(totalDiffDollar)}</strong></td>
                       <td><strong>${grandTotals["FY25"] !== 0 ? totalDiffPercent.toFixed(1) + "%" : "N/A"}</strong></td></tr>`;
      tbody.insertAdjacentHTML("beforeend", totalRowHTML);
    }

    // For the detailed table, group rows by category and then sort by account number.
    function populateDetailedTable(data) {
      const filteredData = filterRevenueData(data);
      // Group rows by category.
      const groups = {};
      filteredData.forEach(row => {
        const info = classifyRevenue(row);
        if (!groups[info.category]) groups[info.category] = [];
        groups[info.category].push(row);
      });
      const tbody = document.querySelector("#detailedTable tbody");
      tbody.innerHTML = "";
      const grandTotals = { "FY21": 0, "FY22": 0, "FY23": 0, "FY24": 0, "FY25": 0, "FY26": 0 };
      Object.keys(groups).sort().forEach(cat => {
        // Category header row.
        const catHeader = document.createElement("tr");
        catHeader.innerHTML = `<td colspan="10" style="background-color:#d1ecf1;"><strong>${cat}</strong></td>`;
        tbody.appendChild(catHeader);
        const categoryTotals = { "FY21": 0, "FY22": 0, "FY23": 0, "FY24": 0, "FY25": 0, "FY26": 0 };
        // Sort rows by account number (if present); otherwise by Subcategory1.
        const rows = groups[cat].sort((a, b) => {
          const accA = a["Account Number"] ? a["Account Number"].trim() : a["Subcategory1"];
          const accB = b["Account Number"] ? b["Account Number"].trim() : b["Subcategory1"];
          return accA.localeCompare(accB);
        });
        rows.forEach(row => {
          const info = classifyRevenue(row);
          const valFY21 = getNum(row, fiscalColumns["FY21"]);
          const valFY22 = getNum(row, fiscalColumns["FY22"]);
          const valFY23 = getNum(row, fiscalColumns["FY23"]);
          const valFY24 = getNum(row, fiscalColumns["FY24"]);
          const valFY25 = getNum(row, fiscalColumns["FY25"]);
          const valFY26 = getNum(row, fiscalColumns["FY26"]);
          const rowDiffDollar = valFY26 - valFY25;
          const rowDiffPercent = valFY25 !== 0 ? (rowDiffDollar / valFY25 * 100) : 0;
          // Create a row; assign an id using the account number if present.
          const detailRow = document.createElement("tr");
          if (info.account) {
            detailRow.id = "acct-" + info.account.replace(/\s+/g, "");
          }
          detailRow.innerHTML = `<td>${row["Subcategory1"]}</td>
                                 <td>${row["Subcategory2"] || row["Subcategory1"]}</td>
                                 <td>${formatDollar(valFY21)}</td>
                                 <td>${formatDollar(valFY22)}</td>
                                 <td>${formatDollar(valFY23)}</td>
                                 <td>${formatDollar(valFY24)}</td>
                                 <td>${formatDollar(valFY25)}</td>
                                 <td>${formatDollar(valFY26)}</td>
                                 <td>${formatDollar(rowDiffDollar)}</td>
                                 <td>${valFY25 !== 0 ? rowDiffPercent.toFixed(1) + "%" : "N/A"}</td>`;
          tbody.appendChild(detailRow);
          ["FY21", "FY22", "FY23", "FY24", "FY25", "FY26"].forEach(col => {
            categoryTotals[col] += getNum(row, fiscalColumns[col]);
          });
        });
        const catDiffDollar = categoryTotals["FY26"] - categoryTotals["FY25"];
        const catDiffPercent = categoryTotals["FY25"] !== 0 ? (catDiffDollar / categoryTotals["FY25"] * 100) : 0;
        const catSummary = document.createElement("tr");
        catSummary.innerHTML = `<td colspan="2"><strong>Total for ${cat}</strong></td>
                                <td><strong>${formatDollar(categoryTotals["FY21"])}</strong></td>
                                <td><strong>${formatDollar(categoryTotals["FY22"])}</strong></td>
                                <td><strong>${formatDollar(categoryTotals["FY23"])}</strong></td>
                                <td><strong>${formatDollar(categoryTotals["FY24"])}</strong></td>
                                <td><strong>${formatDollar(categoryTotals["FY25"])}</strong></td>
                                <td><strong>${formatDollar(categoryTotals["FY26"])}</strong></td>
                                <td><strong>${formatDollar(catDiffDollar)}</strong></td>
                                <td><strong>${categoryTotals["FY25"] !== 0 ? catDiffPercent.toFixed(1) + "%" : "N/A"}</strong></td>`;
        tbody.appendChild(catSummary);
        Object.keys(categoryTotals).forEach(col => {
          grandTotals[col] += categoryTotals[col];
        });
      });
      if (Object.keys(grandTotals).length > 0) {
        const gtDiffDollar = grandTotals["FY26"] - grandTotals["FY25"];
        const gtDiffPercent = grandTotals["FY25"] !== 0 ? (gtDiffDollar / grandTotals["FY25"] * 100) : 0;
        const grandRow = document.createElement("tr");
        grandRow.innerHTML = `<td colspan="2"><strong>Grand Total</strong></td>
                              <td><strong>${formatDollar(grandTotals["FY21"])}</strong></td>
                              <td><strong>${formatDollar(grandTotals["FY22"])}</strong></td>
                              <td><strong>${formatDollar(grandTotals["FY23"])}</strong></td>
                              <td><strong>${formatDollar(grandTotals["FY24"])}</strong></td>
                              <td><strong>${formatDollar(grandTotals["FY25"])}</strong></td>
                              <td><strong>${formatDollar(grandTotals["FY26"])}</strong></td>
                              <td><strong>${formatDollar(gtDiffDollar)}</strong></td>
                              <td><strong>${grandTotals["FY25"] !== 0 ? gtDiffPercent.toFixed(1) + "%" : "N/A"}</strong></td>`;
        tbody.insertAdjacentHTML("beforeend", grandRow.outerHTML);
      }
    }

    // Populate the sidebar with links to detailed rows using account numbers.
    function populateSidebar(data) {
      const container = document.getElementById("sidebarContainer");
      container.innerHTML = "";
      // Group by category then by unique revenue source (using account number if available).
      const groups = {};
      data.forEach(row => {
        const info = classifyRevenue(row);
        if (!allowedCategories.includes(info.category.toLowerCase())) return;
        if (!groups[info.category]) groups[info.category] = {};
        const key = info.account ? info.account : info.sub1;
        // Use the first occurrence for this key.
        if (!groups[info.category][key]) {
          groups[info.category][key] = row;
        }
      });
      for (let cat in groups) {
        let catDiv = document.createElement("div");
        catDiv.classList.add("function-heading");
        catDiv.innerText = cat;
        container.appendChild(catDiv);
        let ul = document.createElement("ul");
        ul.classList.add("list-unstyled");
        Object.keys(groups[cat]).sort().forEach(key => {
          const row = groups[cat][key];
          const info = classifyRevenue(row);
          let linkText = info.sub1;
          let anchorId = row["Account Number"] ? "acct-" + row["Account Number"].trim().replace(/\s+/g, "") : info.sub1.replace(/\s+/g, "-");
          let li = document.createElement("li");
          li.classList.add("dept-link");
          let a = document.createElement("a");
          a.href = "#" + anchorId;
          a.innerText = linkText;
          li.appendChild(a);
          ul.appendChild(li);
        });
        container.appendChild(ul);
      }
    }

    function loadRevenueData() {
      Papa.parse("Revenues.csv", {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        trimHeaders: true,
        complete: function(results) {
          console.log("Revenues CSV loaded:", results.data);
          revenueData = results.data;
          logCSVHeaders(revenueData);
          const filteredData = filterRevenueData(revenueData);
          console.log("Filtered Revenue Rows:", filteredData.length);
          const aggregated = aggregateRevenueData(filteredData);
          console.log("Aggregated Revenue Data:", aggregated);
          drawBarChart(aggregated);
          populateSummaryTable(filteredData);
          populateDetailedTable(filteredData);
          populateSidebar(filteredData);
        },
        error: function(err) { console.error("Error loading Revenues CSV:", err); }
      });
    }

    window.onload = function() {
      loadRevenueData();
    };
  </script>
</body>
</html>
