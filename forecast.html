<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutland Budget Portal - Forecast</title>
  <!-- Bootstrap CSS for styling -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- Chart.js for charting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { padding-top: 60px; }
    .container { margin-top: 80px; }
    .chart-container { max-width: 1000px; margin: 0 auto; }
    /* Detailed forecast table styling */
    #forecastTable { font-size: 0.8rem; width: 100%; border-collapse: collapse; }
    #forecastTable th, #forecastTable td { padding: 8px; border: 1px solid #ddd; white-space: nowrap; }
    #forecastTable th { background-color: #f2f2f2; }
    #forecastTable tbody tr:nth-child(odd) { background-color: #f9f9f9; }
    #forecastTable tbody tr:nth-child(even) { background-color: #fff; }
    /* Navbar styling */
    .navbar-brand, .nav-link { font-size: 1.25rem; }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="index.html">
      <img src="town_seal.png" alt="Town Seal" style="height:40px; margin-right:10px;">
      Rutland Budget Portal
    </a>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mr-auto">
         <li class="nav-item"><a class="nav-link" href="index.html">Overview</a></li>
         <li class="nav-item"><a class="nav-link" href="revenues.html">Revenues</a></li>
         <li class="nav-item"><a class="nav-link" href="expenses.html">Expenses</a></li>
         <li class="nav-item"><a class="nav-link" href="reserves.html">Reserves</a></li>
         <li class="nav-item active"><a class="nav-link" href="forecast.html">Forecast</a></li>
      </ul>
      <span class="navbar-text">
         <a class="nav-link" href="https://www.rutlandma.gov/finance" target="_blank" style="color:#fff;">Back to RutlandMA.gov</a>
      </span>
    </div>
  </nav>
  
  <div class="container">
    <h1 class="mb-4">Forecast (FY2025 - FY2030)</h1>
    <p>
      This forecast is based on the data provided in the CSV file. Each row represents a forecast line‐item.
      <br><br>
      • Rows with Account Numbers beginning with "010-REV" are revenue items. Their FY2025 value is taken from the "FY2025 Budget" column.
      <br>
      • Rows with Account Numbers beginning with "010-EXP" are expense items. Their FY2026 value is taken from the "FY2026 Budget" column.
      <br>
      For both types, the FY2027–FY2030 columns (Forecast) are used.
      <br><br>
      The table below shows detailed forecast items (by Description), followed by subtotals for revenues and expenses, and finally the overall net position (Revenue minus Expense) in accounting format.
    </p>
    
    <!-- Chart Section -->
    <div class="chart-container">
      <h3>Forecast: Revenue vs. Expense</h3>
      <canvas id="forecastChart" width="1000" height="400"></canvas>
    </div>
    
    <!-- Detailed Forecast Table -->
    <h3 class="mt-4">Forecast Detail Table</h3>
    <table id="forecastTable" class="table table-bordered">
      <thead>
        <tr>
          <th>Description</th>
          <th>FY2025</th>
          <th>FY2026</th>
          <th>FY2027</th>
          <th>FY2028</th>
          <th>FY2029</th>
          <th>FY2030</th>
        </tr>
      </thead>
      <tbody id="forecastTableBody">
        <!-- Detailed rows will be injected dynamically -->
      </tbody>
    </table>
  </div>
  
  <script>
    const DEBUG = true;
    let forecastData = null;
    
    // Load forecast.csv using Papa Parse.
    function loadForecastData() {
      Papa.parse("forecast.csv", {
        download: true,
        header: true,
        complete: function(results) {
          if(DEBUG) console.log("Forecast CSV loaded:", results.data);
          forecastData = results.data;
          runForecast();
        },
        error: function(err) {
          console.error("Error loading forecast.csv:", err);
        }
      });
    }
    
    // Helper: Remove $ and commas then parse as float; return 0 if missing.
    function extractValue(val) {
      if (!val) return 0;
      let s = val.toString().replace(/\$/g, "").replace(/,/g, "").trim();
      let num = parseFloat(s);
      return isNaN(num) ? 0 : Math.round(num);
    }
    
    // Helper: Format a number as currency with no decimals.
    function formatDollar(value) {
      return "$" + Math.round(value).toLocaleString("en-US");
    }
    
    // Helper: Format accounting style (negative numbers in parentheses)
    function formatAccounting(value) {
      let rounded = Math.round(value);
      if(rounded < 0) {
        return "(" + formatDollar(Math.abs(rounded)) + ")";
      }
      return formatDollar(rounded);
    }
    
    // Determine if a row is revenue or expense based on Account Number prefix.
    function isRevenue(row) {
      let acct = row["Account Number"] ? row["Account Number"].trim() : "";
      return acct.startsWith("010-REV");
    }
    function isExpense(row) {
      let acct = row["Account Number"] ? row["Account Number"].trim() : "";
      return acct.startsWith("010-EXP");
    }
    
    // Build the detailed forecast table.
    function populateForecastDetailTable(data) {
      // We'll use these columns:
      // "Description", FY2025, FY2026, FY2027, FY2028, FY2029, FY2030.
      const tbody = document.getElementById("forecastTableBody");
      tbody.innerHTML = "";
      
      // Separate rows by type.
      let revenueRows = data.filter(isRevenue);
      let expenseRows = data.filter(isExpense);
      
      // Helper function to create a row for a forecast line item.
      // For revenue rows, use:
      //   FY2025: from "FY2025 Budget"
      //   FY2026: blank (or 0? We'll leave blank)
      //   FY2027-2030: from forecast columns.
      // For expense rows, use:
      //   FY2025: blank
      //   FY2026: from "FY2026 Budget"
      //   FY2027-2030: from forecast columns.
      function createDetailRow(row, type) {
        let desc = row["Description"] ? row["Description"].trim() : "";
        let fy2025 = type === "revenue" ? extractValue(row["FY2025 Budget"]) : "";
        let fy2026 = type === "expense" ? extractValue(row["FY2026 Budget"]) : "";
        let fy2027 = extractValue(row["FY2027 Forecast"]);
        let fy2028 = extractValue(row["FY2028 Forecast"]);
        let fy2029 = extractValue(row["FY2029 Forecast"]);
        let fy2030 = extractValue(row["FY2030 Forecast"]);
        return {
          desc,
          fy2025,
          fy2026,
          fy2027,
          fy2028,
          fy2029,
          fy2030
        };
      }
      
      // Build arrays of detail rows.
      let revenueDetails = revenueRows.map(row => createDetailRow(row, "revenue"));
      let expenseDetails = expenseRows.map(row => createDetailRow(row, "expense"));
      
      // Function to build table rows from an array of detail objects.
      function buildRows(details) {
        let html = "";
        details.forEach(item => {
          html += "<tr>";
          html += `<td>${item.desc}</td>`;
          html += `<td>${item.fy2025 !== "" ? formatDollar(item.fy2025) : ""}</td>`;
          html += `<td>${item.fy2026 !== "" ? formatDollar(item.fy2026) : ""}</td>`;
          html += `<td>${formatDollar(item.fy2027)}</td>`;
          html += `<td>${formatDollar(item.fy2028)}</td>`;
          html += `<td>${formatDollar(item.fy2029)}</td>`;
          html += `<td>${formatDollar(item.fy2030)}</td>`;
          html += "</tr>";
        });
        return html;
      }
      
      // Build subtotal rows.
      function buildSubtotalRow(details, label) {
        let subtotal = { fy2025: 0, fy2026: 0, fy2027: 0, fy2028: 0, fy2029: 0, fy2030: 0 };
        details.forEach(item => {
          if(item.fy2025 !== "") subtotal.fy2025 += item.fy2025;
          if(item.fy2026 !== "") subtotal.fy2026 += item.fy2026;
          subtotal.fy2027 += item.fy2027;
          subtotal.fy2028 += item.fy2028;
          subtotal.fy2029 += item.fy2029;
          subtotal.fy2030 += item.fy2030;
        });
        let html = "<tr style='font-weight:bold;'>";
        html += `<td>${label} Subtotal</td>`;
        html += `<td>${subtotal.fy2025 ? formatDollar(subtotal.fy2025) : ""}</td>`;
        html += `<td>${subtotal.fy2026 ? formatDollar(subtotal.fy2026) : ""}</td>`;
        html += `<td>${formatDollar(subtotal.fy2027)}</td>`;
        html += `<td>${formatDollar(subtotal.fy2028)}</td>`;
        html += `<td>${formatDollar(subtotal.fy2029)}</td>`;
        html += `<td>${formatDollar(subtotal.fy2030)}</td>`;
        html += "</tr>";
        return { html, subtotal };
      }
      
      // Build table HTML.
      let tableHTML = "";
      
      // Revenue section.
      tableHTML += "<tr><td colspan='7' style='font-weight:bold; background-color:#e0f7fa;'>Revenue Items</td></tr>";
      tableHTML += buildRows(revenueDetails);
      let revenueSubtotals = buildSubtotalRow(revenueDetails, "Revenue");
      tableHTML += revenueSubtotals.html;
      
      // Expense section.
      tableHTML += "<tr><td colspan='7' style='font-weight:bold; background-color:#ffebee;'>Expense Items</td></tr>";
      tableHTML += buildRows(expenseDetails);
      let expenseSubtotals = buildSubtotalRow(expenseDetails, "Expense");
      tableHTML += expenseSubtotals.html;
      
      // Net Position row: for each fiscal year, net = revenue subtotal - expense subtotal.
      let net = {
        fy2025: revenueSubtotals.subtotal.fy2025, // since expense for FY2025 is blank
        fy2026: -expenseSubtotals.subtotal.fy2026, // since revenue for FY2026 is blank for revenue items
        fy2027: revenueSubtotals.subtotal.fy2027 - expenseSubtotals.subtotal.fy2027,
        fy2028: revenueSubtotals.subtotal.fy2028 - expenseSubtotals.subtotal.fy2028,
        fy2029: revenueSubtotals.subtotal.fy2029 - expenseSubtotals.subtotal.fy2029,
        fy2030: revenueSubtotals.subtotal.fy2030 - expenseSubtotals.subtotal.fy2030
      };
      tableHTML += "<tr style='font-weight:bold;'>";
      tableHTML += "<td>Net Position</td>";
      tableHTML += `<td>${formatAccounting(net.fy2025)}</td>`;
      tableHTML += `<td>${formatAccounting(net.fy2026)}</td>`;
      tableHTML += `<td>${formatAccounting(net.fy2027)}</td>`;
      tableHTML += `<td>${formatAccounting(net.fy2028)}</td>`;
      tableHTML += `<td>${formatAccounting(net.fy2029)}</td>`;
      tableHTML += `<td>${formatAccounting(net.fy2030)}</td>`;
      tableHTML += "</tr>";
      
      tbody.innerHTML = tableHTML;
    }
    
    function drawForecastChart(labels, revenueData, expenseData) {
      const ctx = document.getElementById("forecastChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Revenue Forecast",
              data: revenueData,
              borderColor: "#1f77b4",
              backgroundColor: "rgba(31,119,180,0.2)",
              fill: false,
              tension: 0.1,
              borderDash: [5, 5]
            },
            {
              label: "Expense Forecast",
              data: expenseData,
              borderColor: "#d62728",
              backgroundColor: "rgba(214,39,40,0.2)",
              fill: false,
              tension: 0.1,
              borderDash: [5, 5]
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ": " + formatDollar(context.parsed.y);
                }
              }
            },
            legend: { position: "bottom" }
          },
          scales: {
            y: {
              beginAtZero: false,
              title: { display: true, text: "Amount" },
              ticks: {
                callback: function(value) {
                  return "$" + Number(value).toLocaleString();
                }
              }
            },
            x: {
              title: { display: true, text: "Fiscal Year" }
            }
          }
        }
      });
    }
    
    window.onload = function() {
      Papa.parse("forecast.csv", {
        download: true,
        header: true,
        complete: function(results) {
          if(DEBUG) console.log("Forecast CSV loaded:", results.data);
          forecastData = results.data;
          runForecast();
          populateForecastDetailTable(forecastData);
        },
        error: function(err) {
          console.error("Error loading forecast.csv:", err);
        }
      });
    };
  </script>
</body>
</html>
