<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutland Budget Portal - Forecast</title>
  <!-- Bootstrap CSS for styling -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- Chart.js for charting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { padding-top: 60px; }
    .container { margin-top: 80px; }
    .chart-container { max-width: 1000px; margin: 0 auto; }
    /* Flipped summary table styling */
    #forecastTable { font-size: 0.8rem; width: 100%; border-collapse: collapse; }
    #forecastTable th, #forecastTable td { padding: 8px; border: 1px solid #ddd; white-space: nowrap; }
    #forecastTable th { background-color: #f2f2f2; }
    #forecastTable tbody tr:nth-child(odd) { background-color: #f9f9f9; }
    #forecastTable tbody tr:nth-child(even) { background-color: #fff; }
    /* Navbar styling */
    .navbar-brand, .nav-link { font-size: 1.25rem; }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="index.html">
      <img src="town_seal.png" alt="Town Seal" style="height:40px; margin-right:10px;">
      Rutland Budget Portal
    </a>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mr-auto">
         <li class="nav-item"><a class="nav-link" href="index.html">Overview</a></li>
         <li class="nav-item"><a class="nav-link" href="revenues.html">Revenues</a></li>
         <li class="nav-item"><a class="nav-link" href="expenses.html">Expenses</a></li>
         <li class="nav-item"><a class="nav-link" href="reserves.html">Reserves</a></li>
         <li class="nav-item active"><a class="nav-link" href="forecast.html">Forecast</a></li>
      </ul>
      <span class="navbar-text">
         <a class="nav-link" href="https://www.rutlandma.gov/finance" target="_blank" style="color:#fff;">Back to RutlandMA.gov</a>
      </span>
    </div>
  </nav>
  
  <div class="container">
    <h1 class="mb-4">Forecast (FY2025 - FY2030)</h1>
    <p>
      This forecast is based on the data provided in the CSV file. Each row represents a forecast line‐item.
      Rows with account numbers beginning with "010-REV" are revenue items; those starting with "010-EXP" are expense items.
      For revenue items, FY2025 uses the "FY2025 Budget" column; for expense items, FY2025 uses the "FY2026 Budget" column.
      For FY2026–FY2030, the respective forecast columns are used for both.
      The summary table below shows the aggregated totals for Revenue, Expense, and the Net Position (Revenue minus Expense) by fiscal year.
    </p>
    
    <!-- Chart Section -->
    <div class="chart-container">
      <h3>Forecast: Revenue vs. Expense</h3>
      <canvas id="forecastChart" width="1000" height="400"></canvas>
    </div>
    
    <!-- Flipped Summary Table -->
    <h3 class="mt-4">Forecast Summary Table</h3>
    <table id="forecastTable" class="table table-bordered">
      <thead>
        <!-- Header row injected dynamically -->
      </thead>
      <tbody id="forecastTableBody">
        <!-- Data rows injected dynamically -->
      </tbody>
    </table>
  </div>
  
  <script>
    const DEBUG = true;
    let forecastData = null;
    
    // Define forecast columns mapping for each fiscal year.
    // For revenue items, FY2025 uses "FY2025 Budget"; for expense items, FY2025 uses "FY2026 Budget".
    const forecastCols = {
      "FY2025": { revenue: "FY2025 Budget", expense: "FY2026 Budget" },
      "FY2026": { revenue: "FY2026 Budget", expense: "FY2026 Budget" },
      "FY2027": { revenue: "FY2027 Forecast", expense: "FY2027 Forecast" },
      "FY2028": { revenue: "FY2028 Forecast", expense: "FY2028 Forecast" },
      "FY2029": { revenue: "FY2029 Forecast", expense: "FY2029 Forecast" },
      "FY2030": { revenue: "FY2030 Forecast", expense: "FY2030 Forecast" }
    };
    
    // Revenue items have account numbers starting with "010-REV"
    // Expense items have account numbers starting with "010-EXP"
    function isRevenue(row) {
      let acct = row["Account Number"] ? row["Account Number"].trim() : "";
      return acct.startsWith("010-REV");
    }
    function isExpense(row) {
      let acct = row["Account Number"] ? row["Account Number"].trim() : "";
      return acct.startsWith("010-EXP");
    }
    
    // Load forecast.csv using Papa Parse.
    function loadForecastData() {
      Papa.parse("forecast.csv", {
        download: true,
        header: true,
        complete: function(results) {
          if(DEBUG) console.log("Forecast CSV loaded:", results.data);
          forecastData = results.data;
          runForecast();
        },
        error: function(err) {
          console.error("Error loading forecast.csv:", err);
        }
      });
    }
    
    // Helper: Remove $ and commas and parse a number.
    function extractValue(val) {
      if (!val) return 0;
      let s = val.toString().replace(/\$/g, "").replace(/,/g, "").trim();
      let num = parseFloat(s);
      return isNaN(num) ? 0 : num;
    }
    
    // Aggregate forecast data by type for each fiscal year.
    function aggregateForecastData(data) {
      const years = Object.keys(forecastCols); // ["FY2025", "FY2026", "FY2027", "FY2028", "FY2029", "FY2030"]
      let revenueTotals = {};
      let expenseTotals = {};
      years.forEach(year => {
        revenueTotals[year] = 0;
        expenseTotals[year] = 0;
      });
      
      data.forEach(row => {
        if(isRevenue(row)) {
          // Revenue: for FY2025, use "FY2025 Budget"; for later years, use the forecast columns.
          years.forEach(year => {
            let colName = forecastCols[year].revenue;
            revenueTotals[year] += extractValue(row[colName]);
          });
        } else if(isExpense(row)) {
          // Expense: for FY2025, use "FY2026 Budget"; for later years, use the forecast columns.
          years.forEach(year => {
            let colName = forecastCols[year].expense;
            expenseTotals[year] += extractValue(row[colName]);
          });
        }
      });
      
      if(DEBUG) {
        console.log("Revenue Totals:", revenueTotals);
        console.log("Expense Totals:", expenseTotals);
      }
      
      return { years, revenueTotals, expenseTotals };
    }
    
    function runForecast() {
      if (!forecastData) return;
      const { years, revenueTotals, expenseTotals } = aggregateForecastData(forecastData);
      const revenueForecast = years.map(year => revenueTotals[year]);
      const expenseForecast = years.map(year => expenseTotals[year]);
      const netForecast = years.map(year => revenueTotals[year] - expenseTotals[year]);
      
      if(DEBUG) {
        console.log("Forecast Years:", years);
        console.log("Revenue Forecast:", revenueForecast);
        console.log("Expense Forecast:", expenseForecast);
        console.log("Net Forecast:", netForecast);
      }
      
      drawForecastChart(years, revenueForecast, expenseForecast);
      populateForecastTable(years, revenueForecast, expenseForecast, netForecast);
    }
    
    function drawForecastChart(labels, revenueData, expenseData) {
      const ctx = document.getElementById("forecastChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Revenue Forecast",
              data: revenueData,
              borderColor: "#1f77b4",
              backgroundColor: "rgba(31,119,180,0.2)",
              fill: false,
              tension: 0.1,
              borderDash: [5, 5]
            },
            {
              label: "Expense Forecast",
              data: expenseData,
              borderColor: "#d62728",
              backgroundColor: "rgba(214,39,40,0.2)",
              fill: false,
              tension: 0.1,
              borderDash: [5, 5]
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ": " + formatDollar(context.parsed.y);
                }
              }
            },
            legend: { position: "bottom" }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: "Amount" },
              ticks: {
                callback: function(value) {
                  return "$" + Number(value).toLocaleString();
                }
              }
            },
            x: {
              title: { display: true, text: "Fiscal Year" }
            }
          }
        }
      });
    }
    
    function populateForecastTable(labels, revenueData, expenseData, netData) {
      // Build header row: first cell "Metric", then one cell per fiscal year.
      let theadHTML = "<tr><th>Metric</th>";
      labels.forEach(year => {
        theadHTML += `<th>${year}</th>`;
      });
      theadHTML += "</tr>";
      document.querySelector("#forecastTable thead").innerHTML = theadHTML;
      
      // Build rows for Revenue, Expense, and Net Position.
      let tbodyHTML = "";
      tbodyHTML += "<tr><td><strong>Revenue</strong></td>";
      revenueData.forEach(val => {
        tbodyHTML += `<td>${formatDollar(val)}</td>`;
      });
      tbodyHTML += "</tr>";
      
      tbodyHTML += "<tr><td><strong>Expense</strong></td>";
      expenseData.forEach(val => {
        tbodyHTML += `<td>${formatDollar(val)}</td>`;
      });
      tbodyHTML += "</tr>";
      
      tbodyHTML += "<tr><td><strong>Net Position</strong></td>";
      netData.forEach(val => {
        tbodyHTML += `<td>${formatDollar(val)}</td>`;
      });
      tbodyHTML += "</tr>";
      
      document.getElementById("forecastTableBody").innerHTML = tbodyHTML;
    }
    
    window.onload = function() {
      loadForecastData();
    };
  </script>
</body>
</html>
