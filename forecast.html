<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutland Budget Portal - Forecast</title>
  <!-- Bootstrap CSS for styling -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- Chart.js for charting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { padding-top: 60px; }
    .container { margin-top: 80px; }
    .chart-container { max-width: 1000px; margin: 0 auto; }
    /* Flipped summary table styling */
    #forecastTable { font-size: 0.8rem; width: 100%; border-collapse: collapse; }
    #forecastTable th, #forecastTable td { padding: 8px; border: 1px solid #ddd; white-space: nowrap; }
    #forecastTable th { background-color: #f2f2f2; }
    #forecastTable tbody tr:nth-child(odd) { background-color: #f9f9f9; }
    #forecastTable tbody tr:nth-child(even) { background-color: #fff; }
    /* Navbar styling */
    .navbar-brand, .nav-link { font-size: 1.25rem; }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="index.html">
      <img src="town_seal.png" alt="Town Seal" style="height:40px; margin-right:10px;">
      Rutland Budget Portal
    </a>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mr-auto">
         <li class="nav-item"><a class="nav-link" href="index.html">Overview</a></li>
         <li class="nav-item"><a class="nav-link" href="revenues.html">Revenues</a></li>
         <li class="nav-item"><a class="nav-link" href="expenses.html">Expenses</a></li>
         <li class="nav-item"><a class="nav-link" href="reserves.html">Reserves</a></li>
         <li class="nav-item active"><a class="nav-link" href="forecast.html">Forecast</a></li>
      </ul>
      <span class="navbar-text">
         <a class="nav-link" href="https://www.rutlandma.gov/finance" target="_blank" style="color:#fff;">Back to RutlandMA.gov</a>
      </span>
    </div>
  </nav>
  
  <div class="container">
    <h1 class="mb-4">Forecast (FY2025 - FY2030)</h1>
    <p>
      This forecast is based on the data provided in the CSV file. Each row represents a forecast line‐item.
      <br><br>
      • Rows with Account Numbers beginning with "010-REV" are revenue items. Their FY2025 value is taken from the "FY2025 Budget" column.
      <br>
      • Rows with Account Numbers beginning with "010-EXP" are expense items. Their FY2026 value is taken from the "FY2026 Budget" column.
      <br>
      For both types, the FY2027–FY2030 columns (Forecast) are used.
      <br><br>
      The summary table below shows, for each fiscal year (FY2025, FY2026, FY2027, FY2028, FY2029, FY2030), the aggregated Revenue, Expense, and Net Position (Revenue minus Expense).
    </p>
    
    <!-- Chart Section -->
    <div class="chart-container">
      <h3>Forecast: Revenue vs. Expense</h3>
      <canvas id="forecastChart" width="1000" height="400"></canvas>
    </div>
    
    <!-- Flipped Summary Table -->
    <h3 class="mt-4">Forecast Summary Table</h3>
    <table id="forecastTable" class="table table-bordered">
      <thead>
        <!-- Header row will be injected dynamically -->
      </thead>
      <tbody id="forecastTableBody">
        <!-- Data rows will be injected dynamically -->
      </tbody>
    </table>
  </div>
  
  <script>
    const DEBUG = true;
    let forecastData = null;
    
    // Load forecast.csv using Papa Parse.
    function loadForecastData() {
      Papa.parse("forecast.csv", {
        download: true,
        header: true,
        complete: function(results) {
          if(DEBUG) console.log("Forecast CSV loaded:", results.data);
          forecastData = results.data;
          runForecast();
        },
        error: function(err) {
          console.error("Error loading forecast.csv:", err);
        }
      });
    }
    
    // Helper: Remove $ and commas then parse as float; return 0 if missing.
    function extractValue(val) {
      if (!val) return 0;
      let s = val.toString().replace(/\$/g, "").replace(/,/g, "").trim();
      let num = parseFloat(s);
      return isNaN(num) ? 0 : num;
    }
    
    // Aggregate forecast data by type.
    // Fiscal years: FY2025, FY2026, FY2027, FY2028, FY2029, FY2030.
    // Revenue items (010-REV): use "FY2025 Budget" for FY2025 and forecast columns for FY2027–FY2030.
    // Expense items (010-EXP): use "FY2026 Budget" for FY2026 and forecast columns for FY2027–FY2030.
    function aggregateForecastData(data) {
      const years = ["FY2025", "FY2026", "FY2027", "FY2028", "FY2029", "FY2030"];
      let revenueTotals = {};
      let expenseTotals = {};
      years.forEach(year => {
        revenueTotals[year] = 0;
        expenseTotals[year] = 0;
      });
      
      data.forEach(row => {
        let acct = row["Account Number"] ? row["Account Number"].trim() : "";
        if(acct.startsWith("010-REV")) {
          // Revenue row.
          revenueTotals["FY2025"] += extractValue(row["FY2025 Budget"]);
          // For FY2026, assume revenue row has no value (or 0).
          revenueTotals["FY2027"] += extractValue(row["FY2027 Forecast"]);
          revenueTotals["FY2028"] += extractValue(row["FY2028 Forecast"]);
          revenueTotals["FY2029"] += extractValue(row["FY2029 Forecast"]);
          revenueTotals["FY2030"] += extractValue(row["FY2030 Forecast"]);
        } else if(acct.startsWith("010-EXP")) {
          // Expense row.
          expenseTotals["FY2026"] += extractValue(row["FY2026 Budget"]);
          // For FY2025, assume expense row has no value (or 0).
          expenseTotals["FY2027"] += extractValue(row["FY2027 Forecast"]);
          expenseTotals["FY2028"] += extractValue(row["FY2028 Forecast"]);
          expenseTotals["FY2029"] += extractValue(row["FY2029 Forecast"]);
          expenseTotals["FY2030"] += extractValue(row["FY2030 Forecast"]);
        }
      });
      
      if(DEBUG) {
        console.log("Revenue Totals:", revenueTotals);
        console.log("Expense Totals:", expenseTotals);
      }
      
      return { years, revenueTotals, expenseTotals };
    }
    
    function runForecast() {
      if (!forecastData) return;
      const { years, revenueTotals, expenseTotals } = aggregateForecastData(forecastData);
      
      // Build arrays for each fiscal year in order.
      // For FY2025: revenue from "FY2025 Budget", expense = 0.
      // For FY2026: revenue = 0, expense from "FY2026 Budget".
      // For FY2027–FY2030: both.
      const revenueArr = [
        revenueTotals["FY2025"],
        0,
        revenueTotals["FY2027"],
        revenueTotals["FY2028"],
        revenueTotals["FY2029"],
        revenueTotals["FY2030"]
      ];
      const expenseArr = [
        0,
        expenseTotals["FY2026"],
        expenseTotals["FY2027"],
        expenseTotals["FY2028"],
        expenseTotals["FY2029"],
        expenseTotals["FY2030"]
      ];
      const netArr = revenueArr.map((rev, i) => rev - expenseArr[i]);
      
      if(DEBUG) {
        console.log("Fiscal Years:", years);
        console.log("Revenue Array:", revenueArr);
        console.log("Expense Array:", expenseArr);
        console.log("Net Array:", netArr);
      }
      
      drawForecastChart(["FY2025", "FY2026", "FY2027", "FY2028", "FY2029", "FY2030"], revenueArr, expenseArr);
      populateForecastTable(["FY2025", "FY2026", "FY2027", "FY2028", "FY2029", "FY2030"], revenueArr, expenseArr, netArr);
    }
    
    function drawForecastChart(labels, revenueData, expenseData) {
      const ctx = document.getElementById("forecastChart").getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Revenue Forecast",
              data: revenueData,
              borderColor: "#1f77b4",
              backgroundColor: "rgba(31,119,180,0.2)",
              fill: false,
              tension: 0.1,
              borderDash: [5, 5]
            },
            {
              label: "Expense Forecast",
              data: expenseData,
              borderColor: "#d62728",
              backgroundColor: "rgba(214,39,40,0.2)",
              fill: false,
              tension: 0.1,
              borderDash: [5, 5]
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ": " + formatDollar(context.parsed.y);
                }
              }
            },
            legend: { position: "bottom" }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: "Amount" },
              ticks: {
                callback: function(value) {
                  return "$" + Number(value).toLocaleString();
                }
              }
            },
            x: {
              title: { display: true, text: "Fiscal Year" }
            }
          }
        }
      });
    }
    
    function populateForecastTable(labels, revenueData, expenseData, netData) {
      // Build header row: first cell "Metric", then one per fiscal year.
      let theadHTML = "<tr><th>Metric</th>";
      labels.forEach(year => {
        theadHTML += `<th>${year}</th>`;
      });
      theadHTML += "</tr>";
      document.querySelector("#forecastTable thead").innerHTML = theadHTML;
      
      // Build rows for Revenue, Expense, and Net Position.
      let tbodyHTML = "";
      tbodyHTML += "<tr><td><strong>Revenue</strong></td>";
      revenueData.forEach(val => {
        tbodyHTML += `<td>${formatDollar(val)}</td>`;
      });
      tbodyHTML += "</tr>";
      
      tbodyHTML += "<tr><td><strong>Expense</strong></td>";
      expenseData.forEach(val => {
        tbodyHTML += `<td>${formatDollar(val)}</td>`;
      });
      tbodyHTML += "</tr>";
      
      tbodyHTML += "<tr><td><strong>Net Position</strong></td>";
      netData.forEach(val => {
        tbodyHTML += `<td>${formatDollar(val)}</td>`;
      });
      tbodyHTML += "</tr>";
      
      document.getElementById("forecastTableBody").innerHTML = tbodyHTML;
    }
    
    window.onload = function() {
      loadForecastData();
    };
    
    // Helper function: Format a number as currency.
    function formatDollar(value) {
      return "$" + Number(value).toLocaleString("en-US");
    }
  </script>
</body>
</html>
