<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutland Budget Portal - Overview</title>
  <!-- Bootstrap CSS for basic styling -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- D3.js for charting -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <!-- Papa Parse for CSV loading -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      padding-top: 60px;
      font-size: 0.9rem;
    }
    /* Fixed nav bar */
    .navbar {
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }
    /* Main container */
    .container {
      margin-top: 80px;
    }
    /* Chart container */
    #chartContainer {
      margin-bottom: 30px;
    }
    /* Legend container positioned below the chart */
    #chartLegend {
      margin-top: 10px;
      text-align: center;
      font-size: 0.8rem;
    }
    #chartLegend span {
      display: inline-block;
      margin-right: 15px;
      vertical-align: middle;
    }
    #chartLegend span div {
      width: 12px;
      height: 12px;
      display: inline-block;
      margin-right: 5px;
      vertical-align: middle;
    }
    /* Summary table styling */
    #summaryTable {
      margin-top: 30px;
    }
    /* Tooltip styling */
    #tooltip {
      position: absolute;
      pointer-events: none;
      background-color: rgba(0,0,0,0.7);
      color: #fff;
      padding: 5px 8px;
      border-radius: 3px;
      font-size: 0.8rem;
      display: none;
      z-index: 3000;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar with Town Seal and Navigation Buttons -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="#">
      <img src="town_seal.png" alt="Town Seal" style="height:40px; margin-right:10px;">
      Rutland Budget Portal
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" 
            data-target="#navbarNav" aria-controls="navbarNav" 
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active"><a class="nav-link" href="index.html">Overview</a></li>
        <li class="nav-item"><a class="nav-link" href="revenues.html">Revenues</a></li>
        <li class="nav-item"><a class="nav-link" href="expenses.html">Expenses</a></li>
      </ul>
      <span class="navbar-text">
        <a class="nav-link" style="color:#fff;" href="https://www.rutlandma.gov/finance" target="_blank">Back to RutlandMA.gov</a>
      </span>
    </div>
  </nav>

  <div class="container">
    <!-- Welcome Message -->
    <div class="jumbotron py-4">
      <h1 class="display-5">Welcome to the Rutland Budget Portal</h1>
      <p class="lead">
        This portal provides a high-level overview of the town’s budget. Below you’ll find a summary of our expense data.
        The stacked bar chart shows, for each fiscal year (FY21–FY26), the contributions of expense categories.
        Hover over a bar segment to see its dollar value. The summary table below displays the FY25 and FY26 budgets by category (with a Grand Total).
        Revenues data will be added soon.
      </p>
    </div>

    <!-- Stacked Bar Chart -->
    <div id="chartContainer">
      <h3>Expense Budget by Fiscal Year</h3>
      <svg id="stackedBarChart" width="800" height="400"></svg>
      <div id="chartLegend"></div>
    </div>

    <!-- Summary Table -->
    <div id="summaryTable">
      <h3>Expense Summary by Category (FY25 &amp; FY26)</h3>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Category</th>
            <th>FY25 BUDGET</th>
            <th>FY26 BUDGET</th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Tooltip for the chart -->
  <div id="tooltip"></div>

  <!-- JavaScript -->
  <script>
    const DEBUG = true;
    
    // Classification mapping – using deptMapping with an added exception for dept code "300"
    const deptMapping = {
      "114": { department: "Town Clerk / Town Meeting", category: "General Government" },
      "161": { department: "Town Clerk / Town Meeting", category: "General Government" },
      "162": { department: "Town Clerk / Town Meeting", category: "General Government" },
      "163": { department: "Town Clerk / Town Meeting", category: "General Government" },
      "122": { department: "Administration", category: "General Government" },
      "129": { department: "Administration", category: "General Government" },
      "151": { department: "Administration", category: "General Government" },
      "195": { department: "Administration", category: "General Government" },
      "692": { department: "Administration", category: "General Government" },
      "145": { department: "Treasurer/Collector", category: "General Government" },
      "158": { department: "Treasurer/Collector", category: "General Government" },
      "159": { department: "Treasurer/Collector", category: "General Government" },
      "160": { department: "Treasurer/Collector", category: "General Government" },
      "135": { department: "Finance Director/Town Accountant", category: "General Government" },
      "141": { department: "Assessors Office", category: "General Government" },
      "155": { department: "Information Technology", category: "General Government" },
      "156": { department: "Information Technology", category: "General Government" },
      "199": { department: "Community Television", category: "General Government" },
      "171": { department: "Planning, Community Development & Conservation", category: "Land Use" },
      "175": { department: "Planning, Community Development & Conservation", category: "Land Use" },
      "241": { department: "Inspectional Services", category: "Land Use" },
      "242": { department: "Inspectional Services", category: "Land Use" },
      "243": { department: "Inspectional Services", category: "Land Use" },
      "245": { department: "Inspectional Services", category: "Land Use" },
      "510": { department: "Health", category: "Land Use" },
      "131": { department: "Boards/Committees", category: "General Government" },
      "176": { department: "Boards/Committees", category: "General Government" },
      "179": { department: "Boards/Committees", category: "General Government" },
      "182": { department: "Boards/Committees", category: "General Government" },
      "691": { department: "Boards/Committees", category: "General Government" },
      "132": { department: "Boards/Committees", category: "General Government" },
      "210": { department: "Police", category: "Public Safety" },
      "292": { department: "Police", category: "Public Safety" },
      "293": { department: "Police", category: "Public Safety" },
      "220": { department: "Fire", category: "Public Safety" },
      "299": { department: "Dispatch", category: "Public Safety" },
      "421": { department: "Public Works - Administration", category: "Public Works" },
      "423": { department: "Public Works - Operations", category: "Public Works" },
      "422": { department: "Public Works - Operations", category: "Public Works" },
      "429": { department: "Public Works - Operations", category: "Public Works" },
      "430": { department: "Public Works - Operations", category: "Public Works" },
      "433": { department: "Public Works - Operations", category: "Public Works" },
      "294": { department: "Public Works - Operations", category: "Public Works" },
      "491": { department: "Public Works - Operations", category: "Public Works" },
      "650": { department: "Public Works - Operations", category: "Public Works" },
      "652": { department: "Public Works - Operations", category: "Public Works" },
      "424": { department: "Public Works - Operations", category: "Public Works" },
      "192": { department: "Public Works - Facilities", category: "Public Works" },
      "610": { department: "Free Public Library", category: "Human Services" },
      "541": { department: "Council on Aging/Senior Center", category: "Human Services" },
      "543": { department: "Veterans Services", category: "Human Services" },
      "911": { department: "Retirement System Assessment", category: "Undistributed Expenses" },
      "914": { department: "Insurance", category: "Undistributed Expenses" },
      "915": { department: "Insurance", category: "Undistributed Expenses" },
      "916": { department: "Insurance", category: "Undistributed Expenses" },
      "945": { department: "Insurance", category: "Undistributed Expenses" },
      "710": { department: "Debt Service", category: "Undistributed Expenses" },
      "751": { department: "Debt Service", category: "Undistributed Expenses" },
      "992": { department: "Transfers Out", category: "Undistributed Expenses" }
    };

    // Modified classifyAccount to handle dept code "300" as Public Education.
    function classifyAccount(accountNumber) {
      if (!accountNumber) return { category: "Other", department: "Other" };
      const parts = accountNumber.split("-");
      if (parts.length < 3) return { category: "Other", department: "Other" };
      const deptCode = parts[1];
      if (deptCode === "300") {
        // For index.html, we want to aggregate all dept 300 as Public Education.
        return { category: "Education", department: "Public Education" };
      }
      return deptMapping[deptCode] || { category: "Other", department: "Other" };
    }
    
    // For the stacked bar chart, we aggregate expense data by fiscal year.
    const fiscalColumns = {
      "FY21": "FY21 ACTUALS",
      "FY22": "FY22 ACTUALS",
      "FY23": "FY23 ACTUALS",
      "FY24": "FY24 BUDGET",
      "FY25": "FY25 BUDGET",
      "FY26": "FY26 BUDGET"
    };
    
    function aggregateExpenseData(data) {
      const years = Object.keys(fiscalColumns);
      const agg = {};
      years.forEach(year => {
        agg[year] = { fiscalYear: year };
      });
      data.forEach(item => {
        const acct = item["Account Number"] || item["AccountNumber"];
        const info = classifyAccount(acct);
        if (info.category === "Other") return;
        years.forEach(year => {
          const col = fiscalColumns[year];
          const val = parseFloat(item[col] || "0");
          if (!agg[year][info.category]) agg[year][info.category] = 0;
          agg[year][info.category] += isNaN(val) ? 0 : val;
        });
      });
      return years.map(year => agg[year]);
    }
    
    // Draw a stacked bar chart with fiscal years on the x-axis.
    function drawStackedBarChart(data) {
      const svg = d3.select("#stackedBarChart");
      svg.selectAll("*").remove();
      const width = +svg.attr("width");
      const height = +svg.attr("height");
      
      // Extract category keys from the first data row.
      const sample = data[0];
      const categoryKeys = Object.keys(sample).filter(k => k !== "fiscalYear");
      
      const stack = d3.stack().keys(categoryKeys);
      const series = stack(data);
      
      // X scale for fiscal years.
      const x = d3.scaleBand()
                  .domain(data.map(d => d.fiscalYear))
                  .range([60, width - 20])
                  .padding(0.2);
      
      // Y scale.
      const maxTotal = d3.max(data, d => {
        let sum = 0;
        categoryKeys.forEach(k => { sum += d[k] || 0; });
        return sum;
      });
      const y = d3.scaleLinear()
                  .domain([0, maxTotal])
                  .nice()
                  .range([height - 40, 20]);
      
      // Y-axis with abbreviated tick labels.
      const yAxis = d3.axisLeft(y)
                      .ticks(5)
                      .tickFormat(d => formatShortDollar(d));
      
      // Color scale for categories.
      const color = d3.scaleOrdinal()
                      .domain(categoryKeys)
                      .range(d3.schemeTableau10);
      
      // Draw x-axis.
      svg.append("g")
         .attr("transform", `translate(0, ${height - 40})`)
         .call(d3.axisBottom(x));
      
      // Draw y-axis.
      svg.append("g")
         .attr("transform", `translate(60,0)`)
         .call(yAxis);
      
      // Create a group for each layer.
      const groups = svg.selectAll("g.layer")
                        .data(series)
                        .enter().append("g")
                        .attr("class", "layer")
                        .attr("fill", d => color(d.key));
      
      // Create tooltip div.
      const tooltip = d3.select("body").append("div")
                        .attr("id", "tooltip");
      
      groups.selectAll("rect")
            .data(d => d)
            .enter().append("rect")
            .attr("x", d => x(d.data.fiscalYear))
            .attr("y", d => y(d[1]))
            .attr("height", d => y(d[0]) - y(d[1]))
            .attr("width", x.bandwidth())
            .on("mousemove", function(event, d) {
              // Get category from parent group's data.
              const category = this.parentNode.__data__.key;
              const value = d[1] - d[0];
              tooltip.style("display", "block")
                     .html(formatDollar(value))
                     .style("left", (event.pageX + 10) + "px")
                     .style("top", (event.pageY - 25) + "px");
            })
            .on("mouseout", function() {
              tooltip.style("display", "none");
            });
      
      // Build a legend in a separate container (at the bottom)
      const legendData = categoryKeys;
      const legendContainer = d3.select("#chartLegend");
      legendContainer.html("");
      legendData.forEach(key => {
        const legendItem = legendContainer.append("span");
        legendItem.append("div")
                  .style("display", "inline-block")
                  .style("width", "12px")
                  .style("height", "12px")
                  .style("background-color", color(key))
                  .style("margin-right", "5px");
        legendItem.append("span").text(key);
      });
    }
    
    // Aggregate data for the summary table (FY25 and FY26).
    function aggregateSummaryTable(data) {
      const summary = {};
      data.forEach(item => {
        const acct = item["Account Number"] || item["AccountNumber"];
        const info = classifyAccount(acct);
        if (info.category === "Other") return;
        if (!summary[info.category]) {
          summary[info.category] = { category: info.category, "FY25 BUDGET": 0, "FY26 BUDGET": 0 };
        }
        summary[info.category]["FY25 BUDGET"] += getNum(item, "FY25 BUDGET");
        summary[info.category]["FY26 BUDGET"] += getNum(item, "FY26 BUDGET");
      });
      return summary;
    }
    
    // Populate the summary table and include a grand total row.
    function populateSummaryTable(data) {
      const summaryDataObj = aggregateSummaryTable(data);
      // Order categories alphabetically (or use a fixed order if needed)
      const sortedCategories = Object.keys(summaryDataObj).sort();
      const tbody = document.getElementById("summaryBody");
      tbody.innerHTML = "";
      let totalFY25 = 0, totalFY26 = 0;
      sortedCategories.forEach(cat => {
        const d = summaryDataObj[cat];
        totalFY25 += d["FY25 BUDGET"];
        totalFY26 += d["FY26 BUDGET"];
        const row = document.createElement("tr");
        row.innerHTML = `<td>${d.category}</td>
                         <td>${formatDollar(d["FY25 BUDGET"])}</td>
                         <td>${formatDollar(d["FY26 BUDGET"])}</td>`;
        tbody.appendChild(row);
      });
      // Grand Total row
      const totalRow = document.createElement("tr");
      totalRow.innerHTML = `<td><strong>Grand Total</strong></td>
                            <td><strong>${formatDollar(totalFY25)}</strong></td>
                            <td><strong>${formatDollar(totalFY26)}</strong></td>`;
      tbody.appendChild(totalRow);
    }
    
    // Load CSV data and initialize the landing page.
    function loadExpenseData() {
      Papa.parse("budget.csv", {
        download: true,
        header: true,
        complete: function(results) {
          if (DEBUG) console.log("CSV loaded:", results.data);
          const data = results.data;
          const aggregated = aggregateExpenseData(data);
          if (DEBUG) console.log("Aggregated by Fiscal Year:", aggregated);
          drawStackedBarChart(aggregated);
          populateSummaryTable(data);
        },
        error: function(err) { console.error("Error loading CSV:", err); }
      });
    }
    
    window.onload = function() {
      loadExpenseData();
    };
  </script>
</body>
</html>
