<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutland Budget Portal - Overview</title>
  <!-- Bootstrap CSS for basic styling -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- D3.js for charting -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <!-- Papa Parse for CSV loading -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      padding-top: 60px;
      font-size: 0.9rem;
    }
    /* Fixed nav bar styling */
    .navbar {
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
    }
    /* Main container */
    .container {
      margin-top: 80px;
    }
    /* Chart container */
    #chartContainer {
      margin-bottom: 30px;
    }
    /* Summary table styling */
    #summaryTable {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">
      <img src="town_seal.png" alt="Town Seal" style="height:40px; margin-right:10px;">
      Rutland Budget Portal
    </a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active"><a class="nav-link" href="index.html">Overview</a></li>
        <li class="nav-item"><a class="nav-link" href="revenues.html">Revenues</a></li>
        <li class="nav-item"><a class="nav-link" href="expenses.html">Expenses</a></li>
      </ul>
      <span class="navbar-text">
        <a class="nav-link" style="color:#fff;" href="https://www.rutlandma.gov/finance" target="_blank">Back to RutlandMA.gov</a>
      </span>
    </div>
  </nav>

  <div class="container">
    <!-- Welcome Message -->
    <div class="jumbotron py-4">
      <h1 class="display-5">Welcome to the Rutland Budget Portal</h1>
      <p class="lead">
        This portal provides a high-level overview of the town’s budget. Currently, expense data is summarized below.
        FY25 and FY26 budgets are shown by category so you can quickly see where funds are allocated. Revenues data will be added soon.
      </p>
    </div>

    <!-- Stacked Bar Chart by Category for Expense Data -->
    <div id="chartContainer">
      <h3>Expense Budget by Category (FY25 & FY26)</h3>
      <svg id="stackedBarChart" width="800" height="400"></svg>
    </div>

    <!-- Summary Table for Expense Data (FY25 & FY26 only) -->
    <div id="summaryTable">
      <h3>Expense Summary by Category</h3>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Category</th>
            <th>FY25 BUDGET</th>
            <th>FY26 BUDGET</th>
          </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
      </table>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    // DEBUG flag
    const DEBUG = true;

    // Fiscal config for this page – we only care about FY25 and FY26
    const fiscalConfig = {
      keys: ["FY25 BUDGET", "FY26 BUDGET"]
    };

    // Mapping for department codes (for classification)
    const deptMapping = {
      "114": { department: "Town Clerk / Town Meeting", category: "General Government" },
      "161": { department: "Town Clerk / Town Meeting", category: "General Government" },
      "162": { department: "Town Clerk / Town Meeting", category: "General Government" },
      "163": { department: "Town Clerk / Town Meeting", category: "General Government" },
      "122": { department: "Administration", category: "General Government" },
      "129": { department: "Administration", category: "General Government" },
      "151": { department: "Administration", category: "General Government" },
      "195": { department: "Administration", category: "General Government" },
      "692": { department: "Administration", category: "General Government" },
      "145": { department: "Treasurer/Collector", category: "General Government" },
      "158": { department: "Treasurer/Collector", category: "General Government" },
      "159": { department: "Treasurer/Collector", category: "General Government" },
      "160": { department: "Treasurer/Collector", category: "General Government" },
      "135": { department: "Finance Director/Town Accountant", category: "General Government" },
      "141": { department: "Assessors Office", category: "General Government" },
      "155": { department: "Information Technology", category: "General Government" },
      "156": { department: "Information Technology", category: "General Government" },
      "199": { department: "Community Television", category: "General Government" },
      "171": { department: "Planning, Community Development & Conservation", category: "Land Use" },
      "175": { department: "Planning, Community Development & Conservation", category: "Land Use" },
      "241": { department: "Inspectional Services", category: "Land Use" },
      "242": { department: "Inspectional Services", category: "Land Use" },
      "243": { department: "Inspectional Services", category: "Land Use" },
      "245": { department: "Inspectional Services", category: "Land Use" },
      "510": { department: "Health", category: "Land Use" },
      "131": { department: "Boards/Committees", category: "General Government" },
      "176": { department: "Boards/Committees", category: "General Government" },
      "179": { department: "Boards/Committees", category: "General Government" },
      "182": { department: "Boards/Committees", category: "General Government" },
      "691": { department: "Boards/Committees", category: "General Government" },
      "132": { department: "Boards/Committees", category: "General Government" },
      "210": { department: "Police", category: "Public Safety" },
      "292": { department: "Police", category: "Public Safety" },
      "293": { department: "Police", category: "Public Safety" },
      "220": { department: "Fire", category: "Public Safety" },
      "299": { department: "Dispatch", category: "Public Safety" },
      "421": { department: "Public Works - Administration", category: "Public Works" },
      "423": { department: "Public Works - Operations", category: "Public Works" },
      "422": { department: "Public Works - Operations", category: "Public Works" },
      "429": { department: "Public Works - Operations", category: "Public Works" },
      "430": { department: "Public Works - Operations", category: "Public Works" },
      "433": { department: "Public Works - Operations", category: "Public Works" },
      "294": { department: "Public Works - Operations", category: "Public Works" },
      "491": { department: "Public Works - Operations", category: "Public Works" },
      "650": { department: "Public Works - Operations", category: "Public Works" },
      "652": { department: "Public Works - Operations", category: "Public Works" },
      "424": { department: "Public Works - Operations", category: "Public Works" },
      "192": { department: "Public Works - Facilities", category: "Public Works" },
      "610": { department: "Free Public Library", category: "Human Services" },
      "541": { department: "Council on Aging/Senior Center", category: "Human Services" },
      "543": { department: "Veterans Services", category: "Human Services" },
      "911": { department: "Retirement System Assessment", category: "Undistributed Expenses" },
      "914": { department: "Insurance", category: "Undistributed Expenses" },
      "915": { department: "Insurance", category: "Undistributed Expenses" },
      "916": { department: "Insurance", category: "Undistributed Expenses" },
      "945": { department: "Insurance", category: "Undistributed Expenses" },
      "710": { department: "Debt Service", category: "Undistributed Expenses" },
      "751": { department: "Debt Service", category: "Undistributed Expenses" },
      "992": { department: "Transfers Out", category: "Undistributed Expenses" }
    };

    // Helper function to extract a numeric value from an item.
    function getNum(item, key) {
      return Math.round(parseFloat((item[key] || "0").replace(/,/g, "")) || 0);
    }

    // Function to classify an account number into a category.
    function classifyAccount(accountNumber) {
      if (!accountNumber) {
        if (DEBUG) console.log("No account number provided.");
        return { category: "Other", department: "Other" };
      }
      let parts = accountNumber.split("-");
      if (parts.length < 3) {
        if (DEBUG) console.log("Invalid format:", accountNumber);
        return { category: "Other", department: "Other" };
      }
      let deptCode = parts[1];
      // For simplicity, we use deptMapping (exceptions such as function code for dept 300 can be added if needed)
      if (deptMapping[deptCode]) {
        return deptMapping[deptCode];
      }
      return { category: "Other", department: "Other" };
    }
    
    // Data aggregation: group expense data by category and sum FY25 and FY26 budgets.
    function aggregateByCategory(data) {
      const categoryData = {};
      data.forEach(item => {
        const acct = item["Account Number"] || item["AccountNumber"];
        const info = classifyAccount(acct);
        if (info.category === "Other") return;
        if (!categoryData[info.category]) {
          categoryData[info.category] = { "FY25 BUDGET": 0, "FY26 BUDGET": 0 };
        }
        categoryData[info.category]["FY25 BUDGET"] += getNum(item, "FY25 BUDGET");
        categoryData[info.category]["FY26 BUDGET"] += getNum(item, "FY26 BUDGET");
      });
      // Convert to an array for D3.
      return Object.keys(categoryData).map(cat => {
        return { category: cat, 
                 "FY25 BUDGET": categoryData[cat]["FY25 BUDGET"], 
                 "FY26 BUDGET": categoryData[cat]["FY26 BUDGET"] };
      });
    }
    
    // Draw a stacked bar chart using D3.
    function drawStackedBarChart(data) {
      const svg = d3.select("#stackedBarChart");
      const width = +svg.attr("width");
      const height = +svg.attr("height");
      
      // Create stack generator.
      const stack = d3.stack()
                      .keys(fiscalConfig.keys)
                      .order(d3.stackOrderNone)
                      .offset(d3.stackOffsetNone);
      
      const series = stack(data);
      
      // X scale: categories.
      const x = d3.scaleBand()
                  .domain(data.map(d => d.category))
                  .range([50, width - 20])
                  .padding(0.2);
      
      // Y scale: sum of budgets.
      const y = d3.scaleLinear()
                  .domain([0, d3.max(data, d => d["FY25 BUDGET"] + d["FY26 BUDGET"])])
                  .nice()
                  .range([height - 50, 20]);
      
      // Colors for FY25 and FY26.
      const color = d3.scaleOrdinal()
                      .domain(fiscalConfig.keys)
                      .range(["#1f77b4", "#ff7f0e"]);
      
      // Draw X Axis.
      svg.append("g")
         .attr("transform", `translate(0, ${height - 50})`)
         .call(d3.axisBottom(x));
      
      // Draw Y Axis.
      svg.append("g")
         .attr("transform", `translate(50,0)`)
         .call(d3.axisLeft(y));
      
      // Draw bars.
      const groups = svg.selectAll("g.layer")
                        .data(series)
                        .enter().append("g")
                        .attr("class", "layer")
                        .attr("fill", d => color(d.key));
      
      groups.selectAll("rect")
            .data(d => d)
            .enter().append("rect")
            .attr("x", d => x(d.data.category))
            .attr("y", d => y(d[1]))
            .attr("height", d => y(d[0]) - y(d[1]))
            .attr("width", x.bandwidth());
      
      // Add legend.
      const legend = svg.selectAll(".legend")
                        .data(fiscalConfig.keys)
                        .enter().append("g")
                        .attr("class", "legend")
                        .attr("transform", (d, i) => `translate(0, ${i * 20})`);
      
      legend.append("rect")
            .attr("x", width - 18)
            .attr("width", 18)
            .attr("height", 18)
            .attr("fill", d => color(d));
      
      legend.append("text")
            .attr("x", width - 24)
            .attr("y", 9)
            .attr("dy", "0.35em")
            .style("text-anchor", "end")
            .text(d => d);
    }
    
    // Populate the summary table (only FY25 and FY26).
    function populateSummaryTable(data) {
      const tbody = document.getElementById("summaryBody");
      tbody.innerHTML = "";
      data.forEach(d => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${d.category}</td>
                         <td>${formatDollar(d["FY25 BUDGET"])}</td>
                         <td>${formatDollar(d["FY26 BUDGET"])}</td>`;
        tbody.appendChild(row);
      });
    }
    
    // Load the CSV and initialize the landing page.
    function loadExpenseData() {
      Papa.parse("budget.csv", {
        download: true,
        header: true,
        complete: function(results) {
          if (DEBUG) console.log("CSV loaded:", results.data);
          const data = results.data;
          // Aggregate data by category.
          const aggData = aggregateByCategory(data);
          if (DEBUG) console.log("Aggregated Data:", aggData);
          drawStackedBarChart(aggData);
          populateSummaryTable(aggData);
        },
        error: function(err) { console.error("Error loading CSV:", err); }
      });
    }
    
    // Start when page loads.
    window.onload = function() {
      loadExpenseData();
    };
  </script>
</body>
</html>
