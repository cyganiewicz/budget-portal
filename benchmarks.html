<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rutland Budget Portal - Forecast</title>
  <!-- Bootstrap CSS for styling -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- Chart.js for charting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { padding-top: 60px; }
    .container { margin-top: 80px; }
    .chart-container { max-width: 1000px; margin: 0 auto; }
    /* Detailed forecast table styling */
    #forecastTable { font-size: 0.8rem; width: 100%; border-collapse: collapse; }
    #forecastTable th, #forecastTable td { padding: 8px; border: 1px solid #ddd; white-space: nowrap; }
    #forecastTable th { background-color: #f2f2f2; }
    #forecastTable tbody tr:nth-child(odd) { background-color: #f9f9f9; }
    #forecastTable tbody tr:nth-child(even) { background-color: #fff; }
    /* Navbar styling */
    .navbar-brand, .nav-link { font-size: 1.25rem; }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="index.html">
      <img src="town_seal.png" alt="Town Seal" style="height:40px; margin-right:10px;">
      Rutland Budget Portal
    </a>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav mr-auto">
         <li class="nav-item"><a class="nav-link" href="index.html">Overview</a></li>
         <li class="nav-item"><a class="nav-link" href="revenues.html">Revenues</a></li>
         <li class="nav-item"><a class="nav-link" href="expenses.html">Expenses</a></li>
         <li class="nav-item"><a class="nav-link" href="reserves.html">Reserves</a></li>
         <li class="nav-item active"><a class="nav-link" href="forecast.html">Forecast</a></li>
      </ul>
      <span class="navbar-text">
         <a class="nav-link" href="https://www.rutlandma.gov/finance" target="_blank" style="color:#fff;">Back to RutlandMA.gov</a>
      </span>
    </div>
  </nav>
  
  <div class="container">
    <h1 class="mb-4">Forecast (FY2025 - FY2030)</h1>
    <p>
      This forecast is based on the data provided in the CSV file. Each row represents a forecast line‐item.
      <br><br>
      • Rows with Account Numbers beginning with "010-REV" are revenue items. Their values are taken from their respective columns.
      <br>
      • Rows with Account Numbers beginning with "010-EXP" are expense items. Their values are taken from their respective columns.
      <br><br>
      You can also view consolidated indicators for:
      <br>
      <strong>Property Values</strong> – Sum of:
         FY2025 Residential Property Values, FY2025 Open Space Property Values, FY2025 Commercial Property Values, FY2025 Industrial Property Values, FY2025 Personal Property Values, FY2025 Total Property Value.
      <br>
      <strong>Tax Rates by Class</strong> – Average of:
         Residential Tax Rate, Open Space Tax Rate, Commercial Tax Rate, Industrial Tax Rate, Personal Property Tax Rate.
      <br>
      <strong>Expenses by Function</strong> – Sum of:
         General Government Expenses, Police Expenses, Fire Expenses, Other Public Safety Expenses, Education Expenses, Public Works Expenses, Human Services Expenses, Culture and Recreation Expenses, Fixed Costs Expenses, Intergovernment Expenses, Other Expenses, Debt Service Expenses.
      <br><br>
      The chart and table below will update to show the data for the selected indicator.
    </p>
    
    <!-- Dropdown for Indicator Selection -->
    <div class="form-group">
      <label for="indicatorSelect">Select Indicator:</label>
      <select class="form-control" id="indicatorSelect"></select>
    </div>
    
    <!-- Chart Section -->
    <div class="chart-container">
      <h3>Indicator Chart</h3>
      <canvas id="indicatorChart" width="1000" height="400"></canvas>
    </div>
    
    <!-- Detailed Table Section -->
    <div class="table-responsive">
      <h3 class="mt-4">Indicator Data Table</h3>
      <table id="forecastTable" class="table table-bordered">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  
  <!-- Bootstrap JS and dependencies -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  
  <script>
    const DEBUG = true;
    let benchmarksData = [];
    let indicatorChart = null;
    
    // Consolidated indicators object.
    const consolidatedIndicators = {
      "Property Values": {
        columns: [
          "FY2025 Residential Property Values",
          "FY2025 Open Space Property Values",
          "FY2025 Commercial Property Values",
          "FY2025 Industrial Property Values",
          "FY2025 Personal Property Values",
          "FY2025 Total Property Value"
        ],
        aggregate: function(values) {
          // Sum the values.
          return values.reduce((sum, val) => sum + val, 0);
        }
      },
      "Tax Rates by Class": {
        columns: [
          "Residential Tax Rate",
          "Open Space Tax Rate",
          "Commercial Tax Rate",
          "Industrial Tax Rate",
          "Personal Property Tax Rate"
        ],
        aggregate: function(values) {
          // Compute average of nonzero entries.
          let valid = values.filter(v => v !== 0);
          if(valid.length === 0) return 0;
          return valid.reduce((sum, v) => sum + v, 0) / valid.length;
        }
      },
      "Expenses by Function": {
        columns: [
          "General Government Expenses",
          "Police Expenses",
          "Fire Expenses",
          "Other Public Safety Expenses",
          "Education Expenses",
          "Public Works Expenses",
          "Human Services Expenses",
          "Culture and Recreation Expenses",
          "Fixed Costs Expenses",
          "Intergovernment Expenses",
          "Other Expenses",
          "Debt Service Expenses"
        ],
        aggregate: function(values) {
          return values.reduce((sum, val) => sum + val, 0);
        }
      }
    };
    
    // Load benchmarks CSV using Papa Parse.
    function loadBenchmarksData() {
      Papa.parse("benchmarks.csv", {
        download: true,
        header: true,
        complete: function(results) {
          benchmarksData = results.data;
          if(DEBUG) console.log("Benchmarks CSV loaded:", benchmarksData);
          populateIndicatorDropdown();
          // Draw initial view with first indicator in dropdown.
          if (benchmarksData.length > 0) {
            const firstOption = document.getElementById("indicatorSelect").value;
            updateDashboard(firstOption);
          }
        },
        error: function(err) {
          console.error("Error loading benchmarks CSV:", err);
        }
      });
    }
    
    // Populate dropdown with individual indicators (all columns except "Community")
    // and add the consolidated indicators at the top.
    function populateIndicatorDropdown() {
      const select = document.getElementById("indicatorSelect");
      select.innerHTML = "";
      if (benchmarksData.length === 0) return;
      // First add consolidated indicators.
      Object.keys(consolidatedIndicators).forEach(key => {
        let option = document.createElement("option");
        option.value = key;
        option.textContent = key;
        select.appendChild(option);
      });
      // Then add individual indicators (from the CSV) excluding "Community"
      const headers = Object.keys(benchmarksData[0]);
      headers.slice(1).forEach(header => {
        let option = document.createElement("option");
        option.value = header;
        option.textContent = header;
        select.appendChild(option);
      });
      select.addEventListener("change", function() {
        updateDashboard(this.value);
      });
    }
    
    // Update both the chart and the table based on the selected indicator.
    function updateDashboard(indicator) {
      if (DEBUG) console.log("Selected indicator:", indicator);
      if (isConsolidated(indicator)) {
        let { labels, values } = getConsolidatedData(indicator);
        drawChartForIndicator(indicator, labels, values);
        updateTableForIndicator(indicator, labels, values);
      } else {
        // For individual indicators, use the value in that column.
        let labels = [];
        let values = [];
        benchmarksData.forEach(row => {
          labels.push(row["Community"] || "Unknown");
          let val = parseFloat(row[indicator]);
          values.push(isNaN(val) ? 0 : val);
        });
        drawChartForIndicator(indicator, labels, values);
        updateTableForIndicator(indicator, labels, values);
      }
    }
    
    // Check if an indicator is one of the consolidated ones.
    function isConsolidated(indicator) {
      return consolidatedIndicators.hasOwnProperty(indicator);
    }
    
    // For a consolidated indicator, compute its aggregated value for each community.
    function getConsolidatedData(indicator) {
      let labels = [];
      let values = [];
      const cols = consolidatedIndicators[indicator].columns;
      benchmarksData.forEach(row => {
        labels.push(row["Community"] || "Unknown");
        let vals = cols.map(col => {
          let v = parseFloat(row[col]);
          return isNaN(v) ? 0 : v;
        });
        let aggVal = consolidatedIndicators[indicator].aggregate(vals);
        values.push(aggVal);
      });
      return { labels, values };
    }
    
    // Draw the chart using Chart.js.
    function drawChartForIndicator(indicator, labels, dataValues) {
      const ctx = document.getElementById("indicatorChart").getContext("2d");
      if (indicatorChart) {
        indicatorChart.destroy();
      }
      indicatorChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: indicator,
            data: dataValues,
            backgroundColor: "rgba(54, 162, 235, 0.5)",
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return indicator + ": " + context.parsed.y;
                }
              }
            },
            legend: { position: "bottom" }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
    
    // Update the table to show only "Community" and the selected indicator's value.
    function updateTableForIndicator(indicator, labels, dataValues) {
      const table = document.getElementById("forecastTable");
      const thead = table.querySelector("thead");
      const tbody = table.querySelector("tbody");
      thead.innerHTML = "";
      tbody.innerHTML = "";
      // Build header row.
      let headerRow = "<tr><th>Community</th><th>" + indicator + "</th></tr>";
      thead.innerHTML = headerRow;
      // Build data rows.
      benchmarksData.forEach((row, index) => {
        let comm = row["Community"] || "Unknown";
        let val = dataValues[index];
        let rowHTML = "<tr><td>" + comm + "</td><td>" + formatDollar(val) + "</td></tr>";
        tbody.innerHTML += rowHTML;
      });
    }
    
    window.onload = function() {
      loadBenchmarksData();
    };
  </script>
</body>
</html>
