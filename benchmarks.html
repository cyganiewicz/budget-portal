<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community Comparison Dashboard</title>
  <!-- Bootstrap CSS for styling -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- Chart.js for charting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body { padding-top: 60px; }
    .navbar { margin-bottom: 20px; }
    /* Two-column layout */
    .table-container { max-height: 600px; overflow-y: auto; }
    #benchmarksTable { font-size: 0.8rem; }
    #benchmarksTable th, #benchmarksTable td { padding: 8px; border: 1px solid #ddd; }
    #benchmarksTable th { background-color: #f2f2f2; }
    /* Chart container */
    .chart-container { text-align: center; }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="#">Community Comparison</a>
  </nav>
  
  <div class="container-fluid mt-5">
    <div class="row">
      <!-- Left Column: Dropdown and Dynamic Table -->
      <div class="col-md-8">
        <h3>Community Data</h3>
        <div class="form-group">
          <label for="indicatorSelect">Select Indicator:</label>
          <select class="form-control" id="indicatorSelect"></select>
        </div>
        <div class="table-container">
          <table class="table table-striped" id="benchmarksTable">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <!-- Right Column: Chart -->
      <div class="col-md-4">
        <h3>Indicator Chart</h3>
        <canvas id="indicatorChart" width="400" height="400"></canvas>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS and dependencies (for mobile navbar functionality) -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  
  <script>
    const DEBUG = true;
    let benchmarksData = [];
    let indicatorChart = null;
    
    // Consolidated indicators object.
    const consolidatedIndicators = {
      "Property Values": {
        columns: [
          "FY2025 Residential Property Values",
          "FY2025 Open Space Property Values",
          "FY2025 Commercial Property Values",
          "FY2025 Industrial Property Values",
          "FY2025 Personal Property Values",
          "FY2025 Total Property Value"  // Will be used in table only.
        ]
      },
      "Tax Rates by Class": {
        columns: [
          "Residential Tax Rate",
          "Open Space Tax Rate",
          "Commercial Tax Rate",
          "Industrial Tax Rate",
          "Personal Property Tax Rate"
        ]
      },
      "Expenses by Function": {
        columns: [
          "General Government Expenses",
          "Police Expenses",
          "Fire Expenses",
          "Other Public Safety Expenses",
          "Education Expenses",
          "Public Works Expenses",
          "Human Services Expenses",
          "Culture and Recreation Expenses",
          "Fixed Costs Expenses",
          "Intergovernment Expenses",
          "Other Expenses",
          "Debt Service Expenses"
        ]
      }
    };
    
    // Load benchmarks CSV using Papa Parse.
    function loadBenchmarksData() {
      Papa.parse("benchmarks.csv", {
        download: true,
        header: true,
        complete: function(results) {
          benchmarksData = results.data;
          if (DEBUG) console.log("Benchmarks CSV loaded:", benchmarksData);
          populateIndicatorDropdown();
          // Draw initial view with first indicator in dropdown.
          if (benchmarksData.length > 0) {
            const initialIndicator = document.getElementById("indicatorSelect").value;
            updateDashboard(initialIndicator);
          }
        },
        error: function(err) {
          console.error("Error loading benchmarks CSV:", err);
        }
      });
    }
    
    // Populate dropdown with indicator names.
    function populateIndicatorDropdown() {
      const select = document.getElementById("indicatorSelect");
      select.innerHTML = "";
      if (benchmarksData.length === 0) return;
      // Add consolidated indicators first.
      Object.keys(consolidatedIndicators).forEach(key => {
        let option = document.createElement("option");
        option.value = key;
        option.textContent = key;
        select.appendChild(option);
      });
      // Then add individual indicators (from CSV) excluding "Community".
      const headers = Object.keys(benchmarksData[0]);
      headers.slice(1).forEach(header => {
        let option = document.createElement("option");
        option.value = header;
        option.textContent = header;
        select.appendChild(option);
      });
      select.addEventListener("change", function() {
        updateDashboard(this.value);
      });
    }
    
    // Update dashboard (chart and table) based on selected indicator.
    function updateDashboard(indicator) {
      if (DEBUG) console.log("Selected indicator:", indicator);
      if (isConsolidated(indicator)) {
        let { labels, datasets } = getConsolidatedChartData(indicator);
        drawStackedChart(labels, datasets, indicator);
        updateTableForConsolidated(indicator, labels, datasets);
      } else {
        let labels = [];
        let dataValues = [];
        benchmarksData.forEach(row => {
          labels.push(row["Community"] || "Unknown");
          let value = parseFloat(row[indicator]);
          dataValues.push(isNaN(value) ? 0 : value);
        });
        drawBarChart(labels, dataValues, indicator);
        updateTableForIndividual(indicator, labels, dataValues);
      }
    }
    
    function isConsolidated(indicator) {
      return consolidatedIndicators.hasOwnProperty(indicator);
    }
    
    // For consolidated indicators, build stacked datasets.
    function getConsolidatedChartData(indicator) {
      let cols = consolidatedIndicators[indicator].columns;
      // For "Property Values", exclude the "FY2025 Total Property Value" column from the chart.
      if (indicator === "Property Values") {
        cols = cols.filter(col => col !== "FY2025 Total Property Value");
      }
      let labels = [];
      let datasetMap = {};
      cols.forEach(col => { datasetMap[col] = []; });
      
      benchmarksData.forEach(row => {
        let community = row["Community"] || "Unknown";
        labels.push(community);
        cols.forEach(col => {
          let value = extractValue(row[col]);
          datasetMap[col].push(value);
        });
      });
      
      const defaultColors = [
        "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f"
      ];
      let datasets = [];
      cols.forEach((col, index) => {
        datasets.push({
          label: col,
          data: datasetMap[col],
          backgroundColor: defaultColors[index % defaultColors.length]
        });
      });
      
      return { labels, datasets };
    }
    
    // Draw a stacked bar chart.
    function drawStackedChart(labels, datasets, indicator) {
      const ctx = document.getElementById("indicatorChart").getContext("2d");
      if (indicatorChart) { indicatorChart.destroy(); }
      indicatorChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  if (indicator === "Property Values") {
                    return context.dataset.label + ": " + formatDollar(context.parsed.y);
                  }
                  return context.dataset.label + ": " + context.parsed.y;
                }
              }
            },
            legend: { position: "bottom" }
          },
          scales: {
            x: { stacked: true, title: { display: true, text: "Community" } },
            y: { stacked: true, beginAtZero: true, title: { display: true, text: "Value" } }
          }
        }
      });
    }
    
    // Draw a regular bar chart for individual indicators.
    function drawBarChart(labels, dataValues, indicator) {
      const ctx = document.getElementById("indicatorChart").getContext("2d");
      if (indicatorChart) { indicatorChart.destroy(); }
      indicatorChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labels,
          datasets: [{
            label: indicator,
            data: dataValues,
            backgroundColor: "rgba(54, 162, 235, 0.5)",
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  return indicator + ": " + context.parsed.y;
                }
              }
            },
            legend: { position: "bottom" }
          },
          scales: { y: { beginAtZero: true } }
        }
      });
    }
    
    // Update table for individual indicators (Community + indicator column).
    function updateTableForIndividual(indicator, labels, dataValues) {
      const table = document.getElementById("benchmarksTable");
      const thead = table.querySelector("thead");
      const tbody = table.querySelector("tbody");
      thead.innerHTML = "";
      tbody.innerHTML = "";
      let headerRow = "<tr><th>Community</th><th>" + indicator + "</th></tr>";
      thead.innerHTML = headerRow;
      benchmarksData.forEach((row, index) => {
        let community = row["Community"] || "Unknown";
        let value = dataValues[index];
        let formatted = value;
        if (indicator === "Property Values") {
          formatted = formatDollar(value);
        }
        let rowHTML = "<tr><td>" + community + "</td><td>" + formatted + "</td></tr>";
        tbody.innerHTML += rowHTML;
      });
    }
    
    // Update table for consolidated indicators: show Community and each component column.
    function updateTableForConsolidated(indicator, labels, datasets) {
      const table = document.getElementById("benchmarksTable");
      const thead = table.querySelector("thead");
      const tbody = table.querySelector("tbody");
      thead.innerHTML = "";
      tbody.innerHTML = "";
      const cols = consolidatedIndicators[indicator].columns;
      let headerRow = "<tr><th>Community</th>";
      cols.forEach(col => {
        headerRow += `<th>${col}</th>`;
      });
      headerRow += "</tr>";
      thead.innerHTML = headerRow;
      
      benchmarksData.forEach((row, i) => {
        let community = row["Community"] || "Unknown";
        let rowHTML = "<tr><td>" + community + "</td>";
        cols.forEach(col => {
          // Use extractValue to parse the value.
          let value = extractValue(row[col]);
          if (indicator === "Property Values") {
            rowHTML += `<td>${value !== 0 ? formatDollar(value) : 0}</td>`;
          } else {
            rowHTML += `<td>${value !== 0 ? value : 0}</td>`;
          }
        });
        rowHTML += "</tr>";
        tbody.innerHTML += rowHTML;
      });
    }
    
    window.onload = function() {
      loadBenchmarksData();
    };
  </script>
</body>
</html>
